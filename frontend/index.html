<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LetScience</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0f172a',
                        secondary: '#334155',
                        accent: '#0ea5e9',
                    }
                }
            }
        }
    </script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // API Helper
        const fetchProductIntelligence = async (id) => {
            const res = await fetch(`/products/${id}/intelligence`);
            return res.json();
        };

        const fetchProducts = async () => {
            const res = await fetch(`/products/`);
            return res.json();
        }

        // --- Auth API ---
        const login = async (username, password) => {
            const res = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            return res.json();
        };

        const verify2FA = async (code, tempToken) => {
            const res = await fetch('/auth/verify-2fa', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code, temp_token: tempToken })
            });
            return res.json();
        };

        const register = async (username, email, password) => {
            const res = await fetch('/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, email, password })
            });
            return res.json();
        };

        // --- Login Page Component ---
        const LoginPage = ({ onLogin }) => {
            const [mode, setMode] = useState('login'); // 'login' or 'register'
            const [username, setUsername] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [requires2FA, setRequires2FA] = useState(false);
            const [tempToken, setTempToken] = useState('');
            const [twoFACode, setTwoFACode] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    const result = await login(username, password);
                    if (result.requires_2fa) {
                        setRequires2FA(true);
                        setTempToken(result.temp_token);
                    } else if (result.access_token) {
                        localStorage.setItem('token', result.access_token);
                        localStorage.setItem('user', JSON.stringify(result.user));
                        onLogin(result.user);
                    } else {
                        setError(result.detail || 'Login failed');
                    }
                } catch (err) {
                    setError('Connection error');
                }
                setLoading(false);
            };

            const handleVerify2FA = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    const result = await verify2FA(twoFACode, tempToken);
                    if (result.access_token) {
                        localStorage.setItem('token', result.access_token);
                        localStorage.setItem('user', JSON.stringify(result.user));
                        onLogin(result.user);
                    } else {
                        setError(result.detail || 'Invalid 2FA code');
                    }
                } catch (err) {
                    setError('Connection error');
                }
                setLoading(false);
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    const result = await register(username, email, password);
                    if (result.user_id) {
                        setMode('login');
                        setError('');
                        alert('Registration successful! Please login.');
                    } else {
                        setError(result.detail || 'Registration failed');
                    }
                } catch (err) {
                    setError('Connection error');
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-accent/20 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <img src="logo.jpg" alt="LetScience" className="h-20 mx-auto mb-4 rounded-xl" />
                            <h1 className="text-2xl font-bold text-slate-900">LetScience</h1>
                            <p className="text-slate-500 text-sm">BioPharma Intelligence Platform</p>
                        </div>

                        {requires2FA ? (
                            <form onSubmit={handleVerify2FA}>
                                <div className="bg-blue-50 p-4 rounded-lg mb-6 text-center">
                                    <p className="text-blue-700 text-sm">üîê Enter your 2FA code from Google Authenticator</p>
                                </div>
                                <input
                                    type="text"
                                    placeholder="000000"
                                    value={twoFACode}
                                    onChange={(e) => setTwoFACode(e.target.value)}
                                    className="w-full px-4 py-3 border border-slate-200 rounded-lg text-center text-2xl tracking-widest font-mono mb-4"
                                    maxLength="6"
                                />
                                {error && <div className="text-red-500 text-sm mb-4">{error}</div>}
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full bg-accent text-white py-3 rounded-lg font-medium hover:bg-accent/90 disabled:opacity-50"
                                >
                                    {loading ? 'Verifying...' : 'Verify'}
                                </button>
                            </form>
                        ) : mode === 'login' ? (
                            <form onSubmit={handleLogin}>
                                <div className="space-y-4 mb-6">
                                    <input
                                        type="text"
                                        placeholder="Username"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                        className="w-full px-4 py-3 border border-slate-200 rounded-lg"
                                        required
                                    />
                                    <input
                                        type="password"
                                        placeholder="Password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full px-4 py-3 border border-slate-200 rounded-lg"
                                        required
                                    />
                                </div>
                                {error && <div className="text-red-500 text-sm mb-4">{error}</div>}
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full bg-accent text-white py-3 rounded-lg font-medium hover:bg-accent/90 disabled:opacity-50"
                                >
                                    {loading ? 'Logging in...' : 'Login'}
                                </button>
                                <p className="text-center text-sm text-slate-500 mt-4">
                                    Don't have an account? <button type="button" onClick={() => setMode('register')} className="text-accent hover:underline">Register</button>
                                </p>
                            </form>
                        ) : (
                            <form onSubmit={handleRegister}>
                                <div className="space-y-4 mb-6">
                                    <input
                                        type="text"
                                        placeholder="Username"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                        className="w-full px-4 py-3 border border-slate-200 rounded-lg"
                                        required
                                    />
                                    <input
                                        type="email"
                                        placeholder="Email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="w-full px-4 py-3 border border-slate-200 rounded-lg"
                                        required
                                    />
                                    <input
                                        type="password"
                                        placeholder="Password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full px-4 py-3 border border-slate-200 rounded-lg"
                                        required
                                    />
                                </div>
                                {error && <div className="text-red-500 text-sm mb-4">{error}</div>}
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full bg-accent text-white py-3 rounded-lg font-medium hover:bg-accent/90 disabled:opacity-50"
                                >
                                    {loading ? 'Registering...' : 'Register'}
                                </button>
                                <p className="text-center text-sm text-slate-500 mt-4">
                                    Already have an account? <button type="button" onClick={() => setMode('login')} className="text-accent hover:underline">Login</button>
                                </p>
                            </form>
                        )}
                    </div>
                </div>
            );
        };

        // --- Layout Components ---

        const Sidebar = ({ activeView, onViewChange, onLogout, user }) => {
            const menuItems = [
                { id: 'drugs', label: 'Drugs', icon: 'pill' },
                { id: 'reports', label: 'Reports', icon: 'file-text' },
                { id: 'patents', label: 'Patents', icon: 'scroll' },
                { id: 'articles', label: 'Articles', icon: 'file-text' },
                { id: 'conferences', label: 'Conferences', icon: 'mic' },
                { id: 'adme', label: 'ADME', icon: 'activity' },
                { id: 'models', label: 'Models', icon: 'flask-round' },
                { id: 'preclinical', label: 'Preclinical', icon: 'microscope' },
                { id: 'synthesis', label: 'Synthesis', icon: 'flask-conical' },
                { id: 'comparison', label: 'Compare', icon: 'git-compare' },
                { id: 'chat', label: 'Chat w/ Science', icon: 'message-square' },
                { id: 'clinical', label: 'Clinical', icon: 'hospital' },
            ];

            return (
                <div className="w-64 bg-slate-900 text-white flex flex-col h-screen fixed left-0 top-0 z-50 shadow-xl">
                    <div className="p-6 border-b border-slate-800">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-accent rounded-lg flex items-center justify-center font-bold text-white">LS</div>
                            <h1 className="text-xl font-bold tracking-tight">LetScience</h1>
                        </div>
                    </div>

                    <nav className="flex-1 py-6 px-3 space-y-1 overflow-y-auto">
                        <div className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 px-3">Main Menu</div>
                        {menuItems.map(item => (
                            <button
                                key={item.id}
                                onClick={() => onViewChange(item.id)}
                                className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all ${activeView === item.id
                                    ? 'bg-accent text-white shadow-lg'
                                    : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                                    }`}
                            >
                                <i data-lucide={item.icon} className="w-5 h-5"></i>
                                {item.label}
                            </button>
                        ))}
                    </nav>

                    <div className="p-4 border-t border-slate-800 bg-slate-900/50">
                        <div className="flex items-center gap-3 px-2 mb-3">
                            <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-300">
                                {user?.username?.substring(0, 2).toUpperCase()}
                            </div>
                            <div className="flex-1 min-w-0">
                                <p className="text-sm font-medium text-white truncate">{user?.username}</p>
                                <p className="text-xs text-slate-500 truncate">Pro User</p>
                            </div>
                        </div>
                        <button
                            onClick={onLogout}
                            className="w-full flex items-center justify-center gap-2 px-4 py-2 text-xs font-medium text-red-300 hover:text-red-200 hover:bg-red-900/20 rounded-lg transition-colors"
                        >
                            <i data-lucide="log-out" className="w-3 h-3"></i>
                            Log Out
                        </button>
                    </div>
                </div>
            );
        };

        const PatentsView = ({ onSelectProduct }) => {
            const [patents, setPatents] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPatent, setSelectedPatent] = useState(null); // Modal state
            const [filters, setFilters] = useState({
                office: 'All',
                status: 'All',
                product: 'All'
            });

            useEffect(() => {
                fetch('/patents/')
                    .then(res => res.json())
                    .then(data => {
                        setPatents(data);
                        setLoading(false);
                    })
                    .catch(err => setLoading(false));
            }, []);

            // Derived Data
            const uniqueProducts = [...new Set(patents.map(p => p.product_name))].sort();
            const totalPatents = patents.length;
            const expiringSoon = patents.filter(p => {
                if (!p.publication_date) return false;
                const date = new Date(p.publication_date);
                const expiry = new Date(date.setFullYear(date.getFullYear() + 20));
                const now = new Date();
                const diffTime = expiry - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays > 0 && diffDays < 365 * 2; // Expiring in < 2 years
            }).length;

            const filteredPatents = patents.filter(p => {
                const matchesSearch = p.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    p.id.toString().includes(searchTerm) ||
                    p.source_id.toLowerCase().includes(searchTerm.toLowerCase());

                const matchesOffice = filters.office === 'All' ? true :
                    filters.office === 'US' ? p.source_id.startsWith('US') :
                        filters.office === 'EP' ? p.source_id.startsWith('EP') :
                            filters.office === 'WO' ? p.source_id.startsWith('WO') :
                                !['US', 'EP', 'WO'].some(prefix => p.source_id.startsWith(prefix));

                const matchesStatus = filters.status === 'All' ? true : p.status === filters.status;
                const matchesProduct = filters.product === 'All' ? true : p.product_name === filters.product;

                return matchesSearch && matchesOffice && matchesStatus && matchesProduct;
            });

            if (loading) return <div className="p-12 text-center text-slate-500">Loading patents...</div>;

            return (
                <div className="p-8 max-w-7xl mx-auto space-y-8 animate-in fade-in duration-500 relative">
                    {/* Modal */}
                    {selectedPatent && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm animate-in fade-in duration-200" onClick={() => setSelectedPatent(null)}>
                            <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                <div className="p-6 border-b border-slate-100 flex justify-between items-start">
                                    <div>
                                        <div className="flex items-center gap-2 mb-2">
                                            <Badge color={selectedPatent.status === 'Granted' ? 'green' : 'orange'}>{selectedPatent.status}</Badge>
                                            <span className="text-sm font-mono text-slate-400">{selectedPatent.source_id}</span>
                                        </div>
                                        <h3 className="text-xl font-bold text-slate-800 leading-tight">{selectedPatent.title}</h3>
                                    </div>
                                    <button onClick={() => setSelectedPatent(null)} className="text-slate-400 hover:text-slate-600 p-1 hover:bg-slate-100 rounded-lg transition-colors">
                                        <i data-lucide="x" className="w-6 h-6"></i>
                                    </button>
                                </div>
                                <div className="p-6 space-y-6">
                                    {/* Abstract */}
                                    <div>
                                        <h4 className="text-xs font-bold text-slate-500 uppercase mb-2">Abstract</h4>
                                        <p className="text-sm text-slate-600 leading-relaxed">
                                            {selectedPatent.abstract || "No abstract available."}
                                        </p>
                                    </div>

                                    {/* Claims Summary */}
                                    <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                                        <h4 className="text-xs font-bold text-indigo-700 uppercase mb-2 flex items-center gap-2">
                                            <i data-lucide="scroll" className="w-4 h-4"></i>
                                            Key Claims Summary
                                        </h4>
                                        <p className="text-sm text-indigo-900 leading-relaxed">
                                            {selectedPatent.claim_summary || "No specific claim summary available."}
                                        </p>
                                    </div>

                                    {/* Details Grid */}
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <h4 className="text-xs font-bold text-slate-500 uppercase mb-2">Claimed Product</h4>
                                            <div className="bg-slate-50 p-3 rounded-lg border border-slate-200 flex items-center justify-between group cursor-pointer hover:border-accent hover:shadow-sm transition-all"
                                                onClick={() => {
                                                    // Navigate
                                                    onSelectProduct(selectedPatent.product_id);
                                                }}
                                            >
                                                <span className="font-semibold text-slate-700">{selectedPatent.product_name}</span>
                                                <i data-lucide="arrow-right" className="w-4 h-4 text-slate-400 group-hover:text-accent"></i>
                                            </div>
                                        </div>
                                        <div>
                                            <h4 className="text-xs font-bold text-slate-500 uppercase mb-2">Patent Type</h4>
                                            <div className="flex flex-wrap gap-2">
                                                <Badge color="purple">{selectedPatent.patent_type || "Composition of Matter"}</Badge>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Diseases */}
                                    {selectedPatent.diseases_in_claims && (
                                        <div>
                                            <h4 className="text-xs font-bold text-slate-500 uppercase mb-2">Diseases in Claims</h4>
                                            <div className="flex flex-wrap gap-2">
                                                {selectedPatent.diseases_in_claims.split(',').map((d, i) => (
                                                    <span key={i} className="px-2 py-1 bg-rose-50 text-rose-700 text-xs font-medium rounded-full border border-rose-100">
                                                        {d.trim()}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* Metadata */}
                                    <div className="pt-4 border-t border-slate-100 grid grid-cols-2 gap-4 text-xs text-slate-500">
                                        <div>
                                            <span className="block font-medium text-slate-700">Publication Date</span>
                                            {selectedPatent.publication_date ? new Date(selectedPatent.publication_date).toLocaleDateString() : 'N/A'}
                                        </div>
                                        <div>
                                            <span className="block font-medium text-slate-700">Assignee</span>
                                            {selectedPatent.assignee}
                                        </div>
                                    </div>

                                    <div className="flex justify-end pt-2">
                                        <a href={selectedPatent.url} target="_blank" className="flex items-center gap-2 text-sm text-accent font-medium hover:underline">
                                            View Full Source <i data-lucide="external-link" className="w-4 h-4"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="flex justify-between items-end mb-6">
                        <div>
                            <h2 className="text-3xl font-bold text-slate-900 mb-2">Global Patents</h2>
                            <p className="text-slate-500">Comprehensive patent intelligence and expiry tracking.</p>
                        </div>
                        {/* Summary Cards */}
                        <div className="flex gap-4">
                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4 min-w-[180px]">
                                <div className="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center">
                                    <i data-lucide="file-text"></i>
                                </div>
                                <div>
                                    <p className="text-xs text-slate-500 font-medium uppercase">Total Patents</p>
                                    <p className="text-2xl font-bold text-slate-900">{totalPatents}</p>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4 min-w-[180px]">
                                <div className="w-10 h-10 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center">
                                    <i data-lucide="alert-triangle"></i>
                                </div>
                                <div>
                                    <p className="text-xs text-slate-500 font-medium uppercase">Expiring Soon</p>
                                    <p className="text-2xl font-bold text-slate-900">{expiringSoon}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Filters & Toolbar */}
                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-wrap gap-4 items-center">
                        <div className="relative flex-1 min-w-[240px]">
                            <i data-lucide="search" className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                            <input
                                type="text"
                                placeholder="Search by title, ID or assignee..."
                                className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>

                        <div className="flex items-center gap-2">
                            <span className="text-sm font-medium text-slate-600">Office:</span>
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                {['All', 'US', 'EP', 'WO', 'Other'].map(office => (
                                    <button
                                        key={office}
                                        onClick={() => setFilters({ ...filters, office })}
                                        className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${filters.office === office ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'
                                            }`}
                                    >
                                        {office}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <select
                            className="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-700 focus:outline-none focus:border-accent"
                            value={filters.product}
                            onChange={(e) => setFilters({ ...filters, product: e.target.value })}
                        >
                            <option value="All">All Products</option>
                            {uniqueProducts.map(p => <option key={p} value={p}>{p}</option>)}
                        </select>
                    </div>

                    {/* Patents Table */}
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 border-b border-slate-200 text-slate-500 font-medium uppercase text-xs">
                                <tr>
                                    <th className="px-6 py-4">Status</th>
                                    <th className="px-6 py-4">Patent Info</th>
                                    <th className="px-6 py-4">Product</th>
                                    <th className="px-6 py-4">Type</th>
                                    <th className="px-6 py-4 text-right">Expiry Est.</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filteredPatents.length > 0 ? filteredPatents.map(patent => {
                                    // Quick expiry calculation for display
                                    const date = patent.publication_date ? new Date(patent.publication_date) : null;
                                    const expiryDate = date ? new Date(date.setFullYear(date.getFullYear() + 20)).toLocaleDateString() : 'N/A';

                                    return (
                                        <tr key={patent.id} onClick={() => setSelectedPatent(patent)} className="cursor-pointer hover:bg-slate-50/50 transition-colors group">
                                            <td className="px-6 py-4">
                                                <Badge color={patent.status === 'Granted' ? 'green' : 'orange'}>
                                                    {patent.status || 'Unknown'}
                                                </Badge>
                                            </td>
                                            <td className="px-6 py-4">
                                                <div className="font-bold text-slate-900 group-hover:text-accent transition-colors">
                                                    {patent.source_id}
                                                </div>
                                                <div className="text-slate-500 line-clamp-1 max-w-md" title={patent.title}>
                                                    {patent.title}
                                                </div>
                                                <div className="text-xs text-slate-400 mt-1">
                                                    {patent.assignee}
                                                </div>
                                            </td>
                                            <td className="px-6 py-4 font-medium text-slate-700">
                                                {patent.product_name}
                                            </td>
                                            <td className="px-6 py-4 text-slate-600">
                                                {patent.patent_type || 'Composition'}
                                            </td>
                                            <td className="px-6 py-4 text-right font-mono text-slate-500">
                                                {expiryDate}
                                            </td>
                                        </tr>
                                    );
                                }) : (
                                    <tr>
                                        <td colSpan="5" className="px-6 py-12 text-center text-slate-500 italic">
                                            No patents found matching your filters.
                                        </td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                        <div className="bg-slate-50 px-6 py-3 border-t border-slate-200 text-xs text-slate-400 text-right">
                            Showing {filteredPatents.length} of {patents.length} records
                        </div>
                    </div>
                </div>
            );
        };

        const ConferencesView = ({ onSelectProduct }) => {
            const [conferences, setConferences] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedConf, setSelectedConf] = useState(null);
            const [filters, setFilters] = useState({ product: 'All' });

            useEffect(() => {
                fetch('/conferences/').then(res => res.json()).then(data => { setConferences(data); setLoading(false); }).catch(() => setLoading(false));
            }, []);

            const uniqueProducts = [...new Set(conferences.map(c => c.product_name))].sort();
            const filteredConferences = conferences.filter(c => {
                const matchesSearch = c.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    c.conference_name.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesProduct = filters.product === 'All' ? true : c.product_name === filters.product;
                return matchesSearch && matchesProduct;
            });

            if (loading) return <div className="p-12 text-center text-slate-500">Loading conferences...</div>;

            return (
                <div className="p-8 max-w-7xl mx-auto space-y-8 animate-in fade-in duration-500 relative">
                    {selectedConf && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm" onClick={() => setSelectedConf(null)}>
                            <div className="bg-white rounded-2xl shadow-xl max-w-2xl w-full p-6" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4">{selectedConf.title}</h3>
                                <div className="space-y-4">
                                    <div className="bg-slate-50 p-4 rounded-lg">
                                        <h4 className="text-xs font-bold text-slate-500 uppercase mb-2">Conference</h4>
                                        <p>{selectedConf.conference_name}</p>
                                    </div>
                                    <div>
                                        <h4 className="text-xs font-bold text-slate-500 uppercase mb-2">Abstract</h4>
                                        <p className="text-sm text-slate-600 leading-relaxed">{selectedConf.abstract || "No abstract available."}</p>
                                    </div>
                                    <button onClick={() => onSelectProduct(selectedConf.product_id)} className="text-sm text-accent font-medium hover:underline flex items-center gap-2">
                                        View Product <i data-lucide="arrow-right" className="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="flex justify-between items-end">
                        <div>
                            <h2 className="text-3xl font-bold text-slate-900 mb-2">Conferences</h2>
                            <p className="text-slate-500">Key scientific meetings and presentations.</p>
                        </div>
                    </div>
                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-wrap gap-4 items-center">
                        <input type="text" placeholder="Search title or conference..." className="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-4 py-2" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        <select className="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2" value={filters.product} onChange={e => setFilters({ ...filters, product: e.target.value })}>
                            <option value="All">All Products</option>
                            {uniqueProducts.map(p => <option key={p} value={p}>{p}</option>)}
                        </select>
                    </div>
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 border-b border-slate-200 text-slate-500 font-medium uppercase text-xs">
                                <tr><th className="px-6 py-4">Title</th><th className="px-6 py-4">Conference</th><th className="px-6 py-4">Product</th><th className="px-6 py-4 text-right">Date</th></tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filteredConferences.map(c => (
                                    <tr key={c.id} onClick={() => setSelectedConf(c)} className="hover:bg-slate-50 cursor-pointer">
                                        <td className="px-6 py-4 font-medium text-slate-900">{c.title}</td>
                                        <td className="px-6 py-4 text-slate-600">{c.conference_name}</td>
                                        <td className="px-6 py-4 text-slate-600">{c.product_name}</td>
                                        <td className="px-6 py-4 text-right font-mono text-slate-500">{c.date ? new Date(c.date).toLocaleDateString() : 'N/A'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const AdmeView = ({ onSelectProduct }) => {
            const [admeData, setAdmeData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                fetch('/adme/').then(res => res.json()).then(data => { setAdmeData(data); setLoading(false); }).catch(() => setLoading(false));
            }, []);

            // Pivot Logic: Group by Product
            const pivotedData = useMemo(() => {
                const map = {};
                admeData.forEach(item => {
                    if (!map[item.product_name]) {
                        map[item.product_name] = {
                            product_id: item.product_id,
                            product_name: item.product_name,
                            params: {}
                        };
                    }
                    const key = item.parameter.toLowerCase().replace(/[^a-z0-9]/g, '');
                    map[item.product_name].params[key] = { value: item.value, unit: item.unit, original: item.parameter };
                });
                return Object.values(map).sort((a, b) => a.product_name.localeCompare(b.product_name));
            }, [admeData]);

            const filteredData = pivotedData.filter(d => d.product_name.toLowerCase().includes(searchTerm.toLowerCase()));

            const COLS = [
                { id: 'cmax', label: 'Cmax' },
                { id: 'tmax', label: 'Tmax' },
                { id: 'auc', label: 'AUC' },
                { id: 't1/2', label: 'Half-Life (t1/2)', keyMatch: ['halflife', 't12', 't1/2'] },
                { id: 'bioavailability', label: 'Bioavail.', keyMatch: ['bioavailability', 'f'] }
            ];

            const getValue = (row, col) => {
                let match = row.params[col.id];
                if (!match && col.keyMatch) {
                    for (let alias of col.keyMatch) {
                        if (row.params[alias]) { match = row.params[alias]; break; }
                    }
                }
                return match;
            };

            if (loading) return <div className="p-12 text-center text-slate-500">Loading PK data...</div>;

            return (
                <div className="p-8 max-w-7xl mx-auto space-y-8 animate-in fade-in duration-500">
                    <div>
                        <h2 className="text-3xl font-bold text-slate-900 mb-2">Pharmacokinetics (ADME)</h2>
                        <p className="text-slate-500">Comparative PK profiles (Cmax, AUC, Tmax).</p>
                    </div>

                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <div className="relative max-w-md">
                            <i data-lucide="search" className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                            <input type="text" placeholder="Search products..." className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        </div>
                    </div>

                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-x-auto">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 border-b border-slate-200 text-slate-500 font-medium uppercase text-xs">
                                <tr>
                                    <th className="px-6 py-4 sticky left-0 bg-slate-50 shadow-sm z-10 w-48">Product</th>
                                    {COLS.map(col => <th key={col.id} className="px-6 py-4 whitespace-nowrap">{col.label}</th>)}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filteredData.map(row => (
                                    <tr key={row.product_id} className="hover:bg-slate-50 group">
                                        <td className="px-6 py-4 font-bold text-slate-900 bg-white group-hover:bg-slate-50 sticky left-0 shadow-sm z-10 border-r border-slate-100 cursor-pointer hover:text-accent" onClick={() => onSelectProduct(row.product_id)}>
                                            {row.product_name}
                                        </td>
                                        {COLS.map(col => {
                                            const cell = getValue(row, col);
                                            return (
                                                <td key={col.id} className="px-6 py-4 whitespace-nowrap">
                                                    {cell ? (
                                                        <div>
                                                            <span className="font-medium text-slate-800">{cell.value}</span>
                                                            {cell.unit && !String(cell.value).includes(cell.unit) && <span className="text-xs text-slate-400 ml-1">{cell.unit}</span>}
                                                        </div>
                                                    ) : <span className="text-slate-300">-</span>}
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const ArticlesView = ({ onSelectProduct }) => {
            const [articles, setArticles] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedArticle, setSelectedArticle] = useState(null); // Modal state
            const [filters, setFilters] = useState({
                product: 'All'
            });

            useEffect(() => {
                fetch('/articles/')
                    .then(res => res.json())
                    .then(data => {
                        setArticles(data);
                        setLoading(false);
                    })
                    .catch(err => setLoading(false));
            }, []);

            // Derived Data
            const uniqueProducts = [...new Set(articles.map(a => a.product_name))].sort();
            const totalArticles = articles.length;
            const recentPublications = articles.filter(a => {
                if (!a.publication_date) return false;
                const pubDate = new Date(a.publication_date);
                const now = new Date();
                return pubDate.getFullYear() >= now.getFullYear() - 1; // Last 1 yearish
            }).length;

            const filteredArticles = articles.filter(a => {
                const matchesSearch = a.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (a.authors && a.authors.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (a.doi && a.doi.toLowerCase().includes(searchTerm.toLowerCase()));

                const matchesProduct = filters.product === 'All' ? true : a.product_name === filters.product;

                return matchesSearch && matchesProduct;
            });

            if (loading) return <div className="p-12 text-center text-slate-500">Loading articles...</div>;

            return (
                <div className="p-8 max-w-7xl mx-auto space-y-8 animate-in fade-in duration-500 relative">
                    {/* Modal */}
                    {selectedArticle && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm animate-in fade-in duration-200" onClick={() => setSelectedArticle(null)}>
                            <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                <div className="p-6 border-b border-slate-100 flex justify-between items-start">
                                    <div>
                                        <div className="flex items-center gap-2 mb-2">
                                            <Badge color="blue">Publication</Badge>
                                            <span className="text-sm font-mono text-slate-400">{selectedArticle.doi}</span>
                                        </div>
                                        <h3 className="text-xl font-bold text-slate-800 leading-tight">{selectedArticle.title}</h3>
                                    </div>
                                    <button onClick={() => setSelectedArticle(null)} className="text-slate-400 hover:text-slate-600 p-1 hover:bg-slate-100 rounded-lg transition-colors">
                                        <i data-lucide="x" className="w-6 h-6"></i>
                                    </button>
                                </div>
                                <div className="p-6 space-y-6">
                                    {/* Abstract */}
                                    <div>
                                        <h4 className="text-xs font-bold text-slate-500 uppercase mb-2">Abstract</h4>
                                        <p className="text-sm text-slate-600 leading-relaxed">
                                            {selectedArticle.abstract || "No abstract available."}
                                        </p>
                                    </div>

                                    {/* Authors */}
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                        <h4 className="text-xs font-bold text-slate-500 uppercase mb-2 flex items-center gap-2">
                                            <i data-lucide="users" className="w-4 h-4"></i>
                                            Authors
                                        </h4>
                                        <p className="text-sm text-slate-700 italic">
                                            {selectedArticle.authors || "Unknown Authors"}
                                        </p>
                                    </div>

                                    {/* Related Product */}
                                    <div>
                                        <h4 className="text-xs font-bold text-slate-500 uppercase mb-2">Related Product</h4>
                                        <div className="bg-slate-50 p-3 rounded-lg border border-slate-200 flex items-center justify-between group cursor-pointer hover:border-accent hover:shadow-sm transition-all"
                                            onClick={() => {
                                                onSelectProduct(selectedArticle.product_id);
                                            }}
                                        >
                                            <span className="font-semibold text-slate-700">{selectedArticle.product_name}</span>
                                            <i data-lucide="arrow-right" className="w-4 h-4 text-slate-400 group-hover:text-accent"></i>
                                        </div>
                                    </div>

                                    {/* Metadata */}
                                    <div className="pt-4 border-t border-slate-100 grid grid-cols-2 gap-4 text-xs text-slate-500">
                                        <div>
                                            <span className="block font-medium text-slate-700">Publication Date</span>
                                            {selectedArticle.publication_date ? new Date(selectedArticle.publication_date).toLocaleDateString() : 'N/A'}
                                        </div>
                                    </div>

                                    <div className="flex justify-end pt-2">
                                        <a href={selectedArticle.url} target="_blank" className="flex items-center gap-2 text-sm text-accent font-medium hover:underline">
                                            Read Full Article <i data-lucide="external-link" className="w-4 h-4"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="flex justify-between items-end mb-6">
                        <div>
                            <h2 className="text-3xl font-bold text-slate-900 mb-2">Scientific Articles</h2>
                            <p className="text-slate-500">Curated library of clinical and preclinical publications.</p>
                        </div>
                        {/* Summary Cards */}
                        <div className="flex gap-4">
                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4 min-w-[180px]">
                                <div className="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center">
                                    <i data-lucide="library"></i>
                                </div>
                                <div>
                                    <p className="text-xs text-slate-500 font-medium uppercase">Total Articles</p>
                                    <p className="text-2xl font-bold text-slate-900">{totalArticles}</p>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4 min-w-[180px]">
                                <div className="w-10 h-10 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center">
                                    <i data-lucide="sparkles"></i>
                                </div>
                                <div>
                                    <p className="text-xs text-slate-500 font-medium uppercase">Recent (1Y)</p>
                                    <p className="text-2xl font-bold text-slate-900">{recentPublications}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Filters & Toolbar */}
                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-wrap gap-4 items-center">
                        <div className="relative flex-1 min-w-[240px]">
                            <i data-lucide="search" className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                            <input
                                type="text"
                                placeholder="Search by title, authors or DOI..."
                                className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>

                        <select
                            className="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-700 focus:outline-none focus:border-accent"
                            value={filters.product}
                            onChange={(e) => setFilters({ ...filters, product: e.target.value })}
                        >
                            <option value="All">All Products</option>
                            {uniqueProducts.map(p => <option key={p} value={p}>{p}</option>)}
                        </select>
                    </div>

                    {/* Articles Table */}
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 border-b border-slate-200 text-slate-500 font-medium uppercase text-xs">
                                <tr>
                                    <th className="px-6 py-4">Publication</th>
                                    <th className="px-6 py-4">Product</th>
                                    <th className="px-6 py-4">Authors</th>
                                    <th className="px-6 py-4 text-right">Date</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filteredArticles.length > 0 ? filteredArticles.map(article => {
                                    return (
                                        <tr key={article.id} onClick={() => setSelectedArticle(article)} className="cursor-pointer hover:bg-slate-50/50 transition-colors group">
                                            <td className="px-6 py-4">
                                                <div className="font-bold text-slate-900 group-hover:text-accent transition-colors line-clamp-1">
                                                    {article.title}
                                                </div>
                                                <div className="text-xs text-slate-400 mt-1 font-mono">
                                                    {article.doi}
                                                </div>
                                            </td>
                                            <td className="px-6 py-4 font-medium text-slate-700">
                                                {article.product_name}
                                            </td>
                                            <td className="px-6 py-4 text-slate-500 max-w-xs truncate">
                                                {article.authors || 'Unknown'}
                                            </td>
                                            <td className="px-6 py-4 text-right font-mono text-slate-500">
                                                {article.publication_date ? new Date(article.publication_date).toLocaleDateString() : 'N/A'}
                                            </td>
                                        </tr>
                                    );
                                }) : (
                                    <tr>
                                        <td colSpan="4" className="px-6 py-12 text-center text-slate-500 italic">
                                            No articles found matching your filters.
                                        </td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                        <div className="bg-slate-50 px-6 py-3 border-t border-slate-200 text-xs text-slate-400 text-right">
                            Showing {filteredArticles.length} of {articles.length} records
                        </div>
                    </div>
                </div>
            );
        };

        const ModelsView = ({ onSelectProduct }) => {
            const [models, setModels] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filters, setFilters] = useState({ product: 'All', type: 'All' });

            useEffect(() => {
                fetch('/models/').then(res => res.json()).then(data => { setModels(data); setLoading(false); }).catch(() => setLoading(false));
            }, []);

            const uniqueProducts = [...new Set(models.map(m => m.product_name))].sort();
            const uniqueTypes = [...new Set(models.map(m => m.model_type))].sort();
            const filteredModels = models.filter(m => {
                const matchesProduct = filters.product === 'All' ? true : m.product_name === filters.product;
                const matchesType = filters.type === 'All' ? true : m.model_type === filters.type;
                return matchesProduct && matchesType;
            });

            if (loading) return <div className="p-12 text-center text-slate-500">Loading models...</div>;

            return (
                <div className="p-8 max-w-7xl mx-auto space-y-8 animate-in fade-in duration-500">
                    <div>
                        <h2 className="text-3xl font-bold text-slate-900 mb-2">Experimental Models</h2>
                        <p className="text-slate-500">Catalog of in vivo and in vitro models.</p>
                    </div>
                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-wrap gap-4 items-center">
                        <select className="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2" value={filters.product} onChange={e => setFilters({ ...filters, product: e.target.value })}>
                            <option value="All">All Products</option>
                            {uniqueProducts.map(p => <option key={p} value={p}>{p}</option>)}
                        </select>
                        <select className="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2" value={filters.type} onChange={e => setFilters({ ...filters, type: e.target.value })}>
                            <option value="All">All Types</option>
                            {uniqueTypes.map(t => <option key={t} value={t}>{t}</option>)}
                        </select>
                    </div>
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 border-b border-slate-200 text-slate-500 font-medium uppercase text-xs">
                                <tr><th className="px-6 py-4">Product</th><th className="px-6 py-4">Model Name</th><th className="px-6 py-4">Type</th><th className="px-6 py-4">Description</th></tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filteredModels.map(m => (
                                    <tr key={m.id} className="hover:bg-slate-50">
                                        <td className="px-6 py-4 font-bold text-slate-900 cursor-pointer hover:text-accent" onClick={() => onSelectProduct(m.product_id)}>{m.product_name}</td>
                                        <td className="px-6 py-4 font-medium text-slate-700">{m.model_name}</td>
                                        <td className="px-6 py-4"><Badge color="purple">{m.model_type}</Badge></td>
                                        <td className="px-6 py-4 text-slate-500 max-w-md truncate" title={m.description}>{m.description}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const PreclinicalView = ({ onSelectProduct }) => {
            const [pdData, setPdData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filters, setFilters] = useState({ product: 'All', target: 'All' });

            useEffect(() => {
                fetch('/preclinical/').then(res => res.json()).then(data => { setPdData(data); setLoading(false); }).catch(() => setLoading(false));
            }, []);

            const uniqueProducts = [...new Set(pdData.map(d => d.product_name))].sort();
            const uniqueTargets = [...new Set(pdData.map(d => d.target).filter(Boolean))].sort();
            const filteredData = pdData.filter(d => {
                const matchesProduct = filters.product === 'All' ? true : d.product_name === filters.product;
                const matchesTarget = filters.target === 'All' ? true : d.target === filters.target;
                return matchesProduct && matchesTarget;
            });

            if (loading) return <div className="p-12 text-center text-slate-500">Loading pharmacology data...</div>;

            return (
                <div className="p-8 max-w-7xl mx-auto space-y-8 animate-in fade-in duration-500">
                    <div>
                        <h2 className="text-3xl font-bold text-slate-900 mb-2">Preclinical Pharmacology</h2>
                        <p className="text-slate-500">In vitro affinity and potency data (Ki, IC50, EC50).</p>
                    </div>
                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-wrap gap-4 items-center">
                        <select className="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2" value={filters.product} onChange={e => setFilters({ ...filters, product: e.target.value })}>
                            <option value="All">All Products</option>
                            {uniqueProducts.map(p => <option key={p} value={p}>{p}</option>)}
                        </select>
                        <select className="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2" value={filters.target} onChange={e => setFilters({ ...filters, target: e.target.value })}>
                            <option value="All">All Targets</option>
                            {uniqueTargets.map(t => <option key={t} value={t}>{t}</option>)}
                        </select>
                    </div>
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 border-b border-slate-200 text-slate-500 font-medium uppercase text-xs">
                                <tr><th className="px-6 py-4">Product</th><th className="px-6 py-4">Parameter</th><th className="px-6 py-4">Target</th><th className="px-6 py-4">Value</th></tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filteredData.map(d => (
                                    <tr key={d.id} className="hover:bg-slate-50">
                                        <td className="px-6 py-4 font-bold text-slate-900 cursor-pointer hover:text-accent" onClick={() => onSelectProduct(d.product_id)}>{d.product_name}</td>
                                        <td className="px-6 py-4 font-mono text-slate-600">{d.parameter}</td>
                                        <td className="px-6 py-4 text-slate-700">{d.target || '-'}</td>
                                        <td className="px-6 py-4 font-medium text-slate-800">{d.value} {d.unit && !String(d.value).includes(d.unit) ? d.unit : ''}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const ClinicalView = ({ onSelectProduct }) => {
            const [trials, setTrials] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                fetch('/clinical/').then(res => res.json()).then(data => { setTrials(data); setLoading(false); }).catch(() => setLoading(false));
            }, []);

            const filteredTrials = trials.filter(t =>
                t.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                t.nct_id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                t.product_name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (loading) return <div className="p-12 text-center text-slate-500">Loading trials...</div>;

            return (
                <div className="p-8 max-w-7xl mx-auto space-y-8 animate-in fade-in duration-500">
                    <div>
                        <h2 className="text-3xl font-bold text-slate-900 mb-2">Clinical Trials</h2>
                        <p className="text-slate-500">Global registry of ongoing and completed studies.</p>
                    </div>
                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <div className="relative max-w-md">
                            <i data-lucide="search" className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                            <input type="text" placeholder="Search trials, NCT ID or product..." className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        </div>
                    </div>
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 border-b border-slate-200 text-slate-500 font-medium uppercase text-xs">
                                <tr><th className="px-6 py-4">Product</th><th className="px-6 py-4">NCT ID</th><th className="px-6 py-4">Title</th><th className="px-6 py-4">Phase</th><th className="px-6 py-4">Status</th></tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filteredTrials.map(t => (
                                    <tr key={t.id} className="hover:bg-slate-50">
                                        <td className="px-6 py-4 font-bold text-slate-900 cursor-pointer hover:text-accent" onClick={() => onSelectProduct(t.product_id)}>{t.product_name}</td>
                                        <td className="px-6 py-4 font-mono text-slate-600">
                                            <a href={t.url || `https://clinicaltrials.gov/study/${t.nct_id}`} target="_blank" rel="noopener noreferrer" className="hover:text-accent underline decoration-slate-300 hover:decoration-accent transition-all">
                                                {t.nct_id}
                                            </a>
                                        </td>
                                        <td className="px-6 py-4 font-medium text-slate-800 line-clamp-2 max-w-lg">{t.title}</td>
                                        <td className="px-6 py-4"><Badge color="blue">{t.phase}</Badge></td>
                                        <td className="px-6 py-4"><Badge color={t.status === 'Recruiting' ? 'green' : 'slate'}>{t.status}</Badge></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const SynthesisView = ({ onSelectProduct }) => {
            const [schemes, setSchemes] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                fetch('/synthesis/').then(res => res.json()).then(data => { setSchemes(data); setLoading(false); }).catch(() => setLoading(false));
            }, []);

            if (loading) return <div className="p-12 text-center text-slate-500">Loading synthesis data...</div>;

            return (
                <div className="p-8 max-w-7xl mx-auto space-y-8 animate-in fade-in duration-500">
                    <div>
                        <h2 className="text-3xl font-bold text-slate-900 mb-2">Chemical Synthesis</h2>
                        <p className="text-slate-500">Manufacturing routes and retrosynthetic analysis.</p>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        {schemes.map(s => (
                            <div key={s.id} className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden hover:shadow-md transition-shadow">
                                <div className="h-48 bg-slate-100 relative group cursor-pointer" onClick={() => onSelectProduct(s.product_id)}>
                                    {s.image_url ? (
                                        <img src={s.image_url} alt={s.name} className="w-full h-full object-cover" />
                                    ) : (
                                        <div className="w-full h-full flex items-center justify-center text-slate-300">
                                            <i data-lucide="flask-conical" className="w-12 h-12"></i>
                                        </div>
                                    )}
                                    <div className="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100">
                                        <Badge color="white">View Product</Badge>
                                    </div>
                                </div>
                                <div className="p-6">
                                    <div className="flex items-center justify-between mb-2">
                                        <h3 className="font-bold text-lg text-slate-900">{s.product_name}</h3>
                                        <Badge color="purple">Route A</Badge>
                                    </div>
                                    <h4 className="font-medium text-slate-700 mb-2">{s.name}</h4>
                                    <p className="text-sm text-slate-500 line-clamp-3">{s.description}</p>
                                    {s.source_url && (
                                        <div className="mt-4 pt-4 border-t border-slate-100">
                                            <a href={s.source_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-xs font-medium text-blue-600 hover:text-blue-800 transition-colors">
                                                <i data-lucide="external-link" className="w-3 h-3"></i>
                                                View Scheme Source
                                            </a>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const PlaceholderView = ({ title, icon, description }) => (
            <div className="p-8 max-w-5xl mx-auto animate-in fade-in zoom-in duration-300">
                <div className="bg-white rounded-2xl border border-slate-200 p-12 text-center shadow-sm">
                    <div className="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i data-lucide={icon} className="w-10 h-10 text-slate-400"></i>
                    </div>
                    <h2 className="text-2xl font-bold text-slate-900 mb-2">{title} Dashboard</h2>
                    <p className="text-slate-500 max-w-md mx-auto mb-8 text-lg">
                        {description || "Explore and analyze global data."}
                        <br />
                        <span className="text-sm opacity-70">(Coming soon: Comprehensive aggregated view)</span>
                    </p>
                    <button className="px-6 py-2.5 bg-slate-900 text-white rounded-lg hover:bg-slate-800 font-medium transition-colors">
                        Explore Demo Data
                    </button>
                </div>
            </div>
        );

        // --- Components ---

        const Card = ({ title, icon, children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden ${className}`}>
                <div className="bg-slate-50 px-6 py-4 border-b border-slate-100 flex items-center gap-2">
                    {icon && <i data-lucide={icon} className="w-5 h-5 text-accent"></i>}
                    <h3 className="font-semibold text-slate-800">{title}</h3>
                </div>
                <div className="p-6">
                    {children}
                </div>
            </div>
        );

        const Badge = ({ children, color = "blue" }) => {
            const colors = {
                blue: "bg-blue-100 text-blue-700",
                green: "bg-green-100 text-green-700",
                purple: "bg-purple-100 text-purple-700",
                orange: "bg-orange-100 text-orange-700",
            }
            return (
                <span className={`px-2 py-1 rounded-full text-xs font-medium ${colors[color] || colors.blue}`}>
                    {children}
                </span>
            )
        };

        const SectionHeader = ({ icon, title, color }) => (
            <div className="flex items-center gap-2 mb-4">
                {icon && <i data-lucide={icon} className={`w-5 h-5 ${color}`}></i>}
                <h3 className={`font-bold text-lg ${color}`}>{title}</h3>
            </div>
        );

        const Dashboard = ({ onSelectProduct }) => {
            const [products, setProducts] = useState([]);
            const [filters, setFilters] = useState({
                mechanism: '',
                disease: '',
                company: '',
                phase: '',
                sideEffect: ''
            });

            useEffect(() => {
                fetchProducts().then(setProducts);
            }, []);

            // Filter products based on all criteria
            const filteredProducts = products.filter(p => {
                const matchMechanism = !filters.mechanism ||
                    p.description?.toLowerCase().includes(filters.mechanism.toLowerCase());
                const matchDisease = !filters.disease ||
                    p.target_indication?.toLowerCase().includes(filters.disease.toLowerCase());
                const matchCompany = !filters.company ||
                    p.company?.toLowerCase().includes(filters.company.toLowerCase());
                const matchPhase = !filters.phase ||
                    p.development_phase === filters.phase;
                // Side effects would need product detail data - for now match on description
                const matchSideEffect = !filters.sideEffect ||
                    p.description?.toLowerCase().includes(filters.sideEffect.toLowerCase());

                return matchMechanism && matchDisease && matchCompany && matchPhase && matchSideEffect;
            });

            const handleFilterChange = (field, value) => {
                setFilters(prev => ({ ...prev, [field]: value }));
            };

            const clearFilters = () => {
                setFilters({ mechanism: '', disease: '', company: '', phase: '', sideEffect: '' });
            };

            const uniquePhases = [...new Set(products.map(p => p.development_phase).filter(Boolean))];

            return (
                <div className="container mx-auto px-4 py-8">
                    <header className="mb-8 text-center">
                        <img src="logo.jpg" alt="LetScience Logo" className="h-24 mx-auto mb-4 rounded-xl shadow-lg" />
                        <p className="text-slate-500">Advanced Intelligence for Life Sciences</p>
                    </header>

                    {/* Search Filters */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-8">
                        <div className="flex items-center justify-between mb-4">
                            <h2 className="text-lg font-bold text-slate-900">üîç Advanced Search</h2>
                            <button
                                onClick={clearFilters}
                                className="text-sm text-accent hover:underline"
                            >
                                Clear all filters
                            </button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Mechanism</label>
                                <input
                                    type="text"
                                    placeholder="e.g. PD-1, GLP-1..."
                                    value={filters.mechanism}
                                    onChange={(e) => handleFilterChange('mechanism', e.target.value)}
                                    className="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Disease</label>
                                <input
                                    type="text"
                                    placeholder="e.g. Cancer, Diabetes..."
                                    value={filters.disease}
                                    onChange={(e) => handleFilterChange('disease', e.target.value)}
                                    className="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Company</label>
                                <input
                                    type="text"
                                    placeholder="e.g. Merck, Pfizer..."
                                    value={filters.company}
                                    onChange={(e) => handleFilterChange('company', e.target.value)}
                                    className="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Phase</label>
                                <select
                                    value={filters.phase}
                                    onChange={(e) => handleFilterChange('phase', e.target.value)}
                                    className="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"
                                >
                                    <option value="">All phases</option>
                                    {uniquePhases.map(phase => (
                                        <option key={phase} value={phase}>{phase}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Side Effects</label>
                                <input
                                    type="text"
                                    placeholder="e.g. Nausea..."
                                    value={filters.sideEffect}
                                    onChange={(e) => handleFilterChange('sideEffect', e.target.value)}
                                    className="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"
                                />
                            </div>
                        </div>
                        <div className="mt-4 text-sm text-slate-500">
                            Showing <strong>{filteredProducts.length}</strong> of <strong>{products.length}</strong> products
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {filteredProducts.map(p => (
                            <div key={p.id}
                                onClick={() => onSelectProduct(p.id)}
                                className="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow cursor-pointer border border-slate-200 group">
                                <div className="flex justify-between items-start mb-4">
                                    <div className="h-12 w-12 bg-accent/10 rounded-lg flex items-center justify-center text-accent">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m16.24 7.76-1.804 5.411a2 2 0 0 1-1.265 1.265L7.76 16.24l1.804-5.411a2 2 0 0 1 1.265-1.265z" /><circle cx="12" cy="12" r="10" /></svg>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        {p.development_phase === 'Approved' && (
                                            <span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded text-xs font-bold">üöÄ Launched</span>
                                        )}
                                        <Badge color={p.development_phase === 'Approved' ? 'green' : 'orange'}>{p.development_phase}</Badge>
                                    </div>
                                </div>
                                <h2 className="text-xl font-bold text-slate-900 mb-2 group-hover:text-accent transition-colors">{p.name}</h2>
                                <p className="text-sm text-slate-500 mb-4 line-clamp-2">{p.description}</p>
                                <div className="text-xs text-slate-400 font-medium uppercase tracking-wider">Indication: {p.target_indication}</div>
                            </div>
                        ))}
                    </div>
                </div>
            )
        };

        const ReportsView = () => {
            const [type, setType] = useState('disease');
            const [query, setQuery] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);

            const handleGenerate = () => {
                if (!query) return;
                setIsGenerating(true);
                // Trigger download
                window.open(`/reports/landscape?type=${type}&query=${encodeURIComponent(query)}`, '_blank');
                setTimeout(() => setIsGenerating(false), 2000);
            };

            return (
                <div className="p-8 max-w-4xl mx-auto space-y-8 animate-in fade-in duration-500">
                    <div>
                        <h2 className="text-3xl font-bold text-slate-900 mb-2">Landscape Reports</h2>
                        <p className="text-slate-500">Generate aggregated intelligence dossiers for diseases, targets, companies, or mechanisms.</p>
                    </div>

                    <div className="bg-white p-8 rounded-2xl border border-slate-200 shadow-lg">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">Report Type</label>
                                    <div className="grid grid-cols-2 gap-3">
                                        {['Disease', 'Target', 'Company', 'Mechanism', 'Drug'].map(t => (
                                            <button
                                                key={t}
                                                onClick={() => setType(t.toLowerCase())}
                                                className={`px-4 py-3 rounded-xl border text-sm font-medium transition-all ${type === t.toLowerCase()
                                                    ? 'border-indigo-500 bg-indigo-50 text-indigo-700 ring-2 ring-indigo-200'
                                                    : 'border-slate-200 text-slate-600 hover:border-slate-300 hover:bg-slate-50'
                                                    }`}
                                            >
                                                {t}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">Search Query</label>
                                    <input
                                        type="text"
                                        value={query}
                                        onChange={(e) => setQuery(e.target.value)}
                                        placeholder={
                                            type === 'disease' ? 'e.g. Melanoma, NSCLC' :
                                                type === 'target' ? 'e.g. PD-1, VEGF' :
                                                    type === 'company' ? 'e.g. Merck, Pfizer' :
                                                        'e.g. Monoclonal antibody'
                                        }
                                        className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all"
                                    />
                                    <p className="text-xs text-slate-500 mt-2">
                                        Enter the specific term to aggregate intelligence for.
                                    </p>
                                </div>

                                <button
                                    onClick={handleGenerate}
                                    disabled={!query || isGenerating}
                                    className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition-all disabled:opacity-50 disabled:shadow-none flex items-center justify-center gap-2"
                                >
                                    {isGenerating ? (
                                        <span>Generating Report...</span>
                                    ) : (
                                        <span>Generate PDF Dossier</span>
                                    )}
                                </button>
                            </div>

                            <div className="bg-slate-50 rounded-xl p-6 border border-slate-100 flex flex-col justify-center items-center text-center space-y-4">
                                <div className="text-4xl mb-2">üìä</div>
                                <div>
                                    <h3 className="font-bold text-slate-900">Comprehensive Analysis</h3>
                                    <p className="text-sm text-slate-500 mt-1">
                                        Aggregates data from clinical trials, patent filings, and development milestones into a single comparative document.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ProductDetail = ({ productId, onBack }) => {
            const [data, setData] = useState(null);
            const [activeTab, setActiveTab] = useState('overview');
            const [isSubscribed, setIsSubscribed] = useState(false);
            const [isPlaying, setIsPlaying] = useState(false);
            const [clinicalFilters, setClinicalFilters] = useState({ year: '', sponsor: '', disease: '' });

            // Advanced Filters State
            const [patentFilters, setPatentFilters] = useState({ type: 'all', company: '', year: '', disease: '', office: '' });
            const [conferenceFilters, setConferenceFilters] = useState({ type: 'all', company: '', year: '', disease: '' }); // type: all, poster, oral
            const [scienceFilters, setScienceFilters] = useState({ company: '', year: '', disease: '' });

            useEffect(() => {
                setClinicalFilters({ year: '', sponsor: '', disease: '' });
                setPatentFilters({ type: 'all', company: '', year: '', disease: '', office: '' });
                setConferenceFilters({ type: 'all', company: '', year: '', disease: '' });
                setScienceFilters({ company: '', year: '', disease: '' });
                fetchProductIntelligence(productId).then(setData);
                // Check subscription status
                const token = localStorage.getItem('token');
                if (token) {
                    fetch(`/alerts/check/${productId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                        .then(res => res.json())
                        .then(data => setIsSubscribed(data.subscribed))
                        .catch(() => { });
                }
            }, [productId]);

            useEffect(() => {
                lucide.createIcons();
            }, [data]);

            const toggleSubscription = async () => {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('Please login to subscribe to alerts');
                    return;
                }

                const endpoint = isSubscribed
                    ? `/alerts/unsubscribe/${productId}`
                    : `/alerts/subscribe/${productId}`;
                const method = isSubscribed ? 'DELETE' : 'POST';

                try {
                    const res = await fetch(endpoint, {
                        method,
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await res.json();
                    setIsSubscribed(result.subscribed);
                } catch (err) {
                    console.error('Subscription error:', err);
                }
            };

            // Audio Podcast - Text to Speech
            const playBriefing = () => {
                if (isPlaying) {
                    window.speechSynthesis.cancel();
                    setIsPlaying(false);
                    return;
                }

                const productType = product_info.description?.toLowerCase().includes('antibody') ? 'biologic monoclonal antibody' :
                    product_info.description?.toLowerCase().includes('peptide') || product_info.description?.toLowerCase().includes('glp-1') ? 'peptide-based drug' :
                        'small molecule drug';

                const indicationsText = data.indications?.length > 0
                    ? `indicated for ${data.indications.map(i => i.disease).join(', ')}`
                    : 'under investigation for multiple indications';

                const sideEffectsText = data.side_effects?.length > 0
                    ? `Key safety considerations include ${data.side_effects.slice(0, 3).join(', ')}.`
                    : '';

                const script = `
                    Welcome to your LetScience Intelligence Briefing for ${product_info.name}.

                    ${product_info.name} is a ${product_info.development_phase === 'Approved' ? 'commercially launched' : 'pipeline'} therapeutic ${productType}, targeting ${product_info.target_indication}.

                    Clinical Evidence: This product is supported by ${clinical_trials.length} registered clinical trials and ${scientific_articles.length} peer-reviewed publications documenting its efficacy and safety profile.

                    Mechanism of Action: ${product_info.description}

                    Therapeutic Applications: Currently ${indicationsText}. ${sideEffectsText}

                    Intellectual Property Landscape: The product is protected by ${patents.length} patents covering composition of matter, methods of use, and various claims.

                    Conference Presence: Featured in ${conferences.length} conference presentations at major medical meetings, demonstrating ongoing research interest and clinical development activity.

                    This concludes your LetScience Intelligence Briefing. Thank you for listening.
                    `;

                const utterance = new SpeechSynthesisUtterance(script);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.lang = 'en-US';

                // Try to find a good voice
                const voices = window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(v => v.name.includes('Google') || v.name.includes('Samantha') || v.name.includes('Daniel'));
                if (preferredVoice) utterance.voice = preferredVoice;

                utterance.onend = () => setIsPlaying(false);
                utterance.onerror = () => setIsPlaying(false);

                setIsPlaying(true);
                window.speechSynthesis.speak(utterance);
            };

            if (!data) return <div className="p-10 text-center text-slate-500">Loading Intelligence...</div>;

            const { product_info, patents, scientific_articles, clinical_trials, conferences, pharmacokinetics, pharmacodynamics, experimental_models, synthesis_schemes: synthesis } = data;

            // ==========================================
            // AI Assistant Logic & Component
            // ==========================================
            const AIAssistant = () => {
                const [isOpen, setIsOpen] = useState(false);
                const [input, setInput] = useState('');
                const [messages, setMessages] = useState([
                    { role: 'ai', text: `Hi! I'm your Intelligence Assistant. I can help you filter data (e.g., "Show me Pfizer patents") or navigate (e.g., "Go to trials"). How can I help?` }
                ]);
                const [isTyping, setIsTyping] = useState(false);
                const messagesEndRef = useRef(null);

                const scrollToBottom = () => {
                    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
                };

                useEffect(() => {
                    scrollToBottom();
                }, [messages, isOpen]);

                const processQuery = (query) => {
                    const lowerQ = query.toLowerCase();
                    let response = "I'm not sure how to do that yet. Try asking to filter by company or year.";

                    setIsTyping(true);

                    // Simulate AI thinking
                    setTimeout(() => {
                        // --- NAVIGATION INTENTS ---
                        if (lowerQ.includes('go to') || lowerQ.includes('open') || lowerQ.includes('show tab')) {
                            if (lowerQ.includes('patent')) { setActiveTab('patents'); response = "Navigating to Patents."; }
                            else if (lowerQ.includes('trial') || lowerQ.includes('clinical')) { setActiveTab('clinical'); response = "Opening Clinical Trials."; }
                            else if (lowerQ.includes('conference')) { setActiveTab('conferences'); response = "Switching to Conferences tab."; }
                            else if (lowerQ.includes('preclinical') || lowerQ.includes('pharmacology') || lowerQ.includes('model')) { setActiveTab('preclinical'); response = "Showing Preclinical & Pharmacology data."; }
                            else if (lowerQ.includes('article') || lowerQ.includes('science') || lowerQ.includes('scientific')) { setActiveTab('science'); response = "Showing Scientific Articles."; }
                            else if (lowerQ.includes('timeline') || lowerQ.includes('development')) { setActiveTab('timeline'); response = "Here is the Development Timeline."; }
                            else if (lowerQ.includes('synthesis')) { setActiveTab('synthesis'); response = "Opening Synthesis details."; }
                        }

                        // --- FILTERING INTENTS ---
                        // PATENTS
                        else if (lowerQ.includes('patent') && (lowerQ.includes('show') || lowerQ.includes('find') || lowerQ.includes('filter'))) {
                            if (activeTab !== 'patents') setActiveTab('patents');

                            if (lowerQ.includes('granted')) {
                                setPatentFilters(prev => ({ ...prev, type: 'Granted' }));
                                response = "Filtering for Granted patents.";
                            }
                            else if (lowerQ.includes('product')) {
                                setPatentFilters(prev => ({ ...prev, type: 'Product' }));
                                response = "Showing Product patents.";
                            }
                            else if (lowerQ.includes('20')) { // Simple year detection
                                const year = lowerQ.match(/20\d{2}/)?.[0];
                                if (year) {
                                    setPatentFilters(prev => ({ ...prev, year: year }));
                                    response = `Filtering patents published in ${year}.`;
                                }
                            }
                            else if (lowerQ.includes('reset') || lowerQ.includes('clear')) {
                                setPatentFilters({ type: 'all', company: '', year: '', disease: '', office: '' });
                                response = "Reset all patent filters.";
                            }
                            // Detect company names
                            else {
                                // Try to find a company name from the list in the query
                                const companies = [...new Set(patents.map(p => p.assignee).filter(Boolean))];
                                const foundCompany = companies.find(c => lowerQ.includes(c.toLowerCase()));
                                if (foundCompany) {
                                    setPatentFilters(prev => ({ ...prev, company: foundCompany }));
                                    response = `Filtering patents for ${foundCompany}.`;
                                } else {
                                    // Try disease
                                    const diseases = [...new Set(patents.flatMap(p => p.diseases_in_claims ? p.diseases_in_claims.split(',') : []).map(d => d.trim()))];
                                    const foundDisease = diseases.find(d => lowerQ.includes(d.toLowerCase()));
                                    if (foundDisease) {
                                        setPatentFilters(prev => ({ ...prev, disease: foundDisease }));
                                        response = `Filtering patents related to ${foundDisease}.`;
                                    }
                                }
                            }
                        }

                        // CONFERENCES
                        else if ((lowerQ.includes('conference') || lowerQ.includes('presentation')) && (lowerQ.includes('show') || lowerQ.includes('find'))) {
                            if (activeTab !== 'conferences') setActiveTab('conferences');

                            if (lowerQ.includes('oral')) {
                                setConferenceFilters(prev => ({ ...prev, type: 'oral' }));
                                response = "Showing Oral presentations only.";
                            }
                            else if (lowerQ.includes('poster')) {
                                setConferenceFilters(prev => ({ ...prev, type: 'poster' }));
                                response = "Showing Posters only.";
                            }
                            // Year
                            const year = lowerQ.match(/20\d{2}/)?.[0];
                            if (year) {
                                setConferenceFilters(prev => ({ ...prev, year: year }));
                                response = `Showing conferences from ${year}.`;
                            }
                        }

                        // --- Q&A INTENTS ---
                        else if (lowerQ.includes('how many')) {
                            if (lowerQ.includes('patent')) response = `There are ${patents.length} patents tracked.`;
                            else if (lowerQ.includes('trial')) response = `There are ${clinical_trials.length} clinical trials.`;
                            else if (lowerQ.includes('article') || lowerQ.includes('paper')) response = `There are ${scientific_articles.length} scientific articles.`;
                            else if (lowerQ.includes('conference')) response = `There are ${conferences.length} conference presentations.`;
                        }
                        else if (lowerQ.includes('status') || lowerQ.includes('phase')) {
                            response = `The product is currently in ${product_info.development_phase}.`;
                        }
                        else if (lowerQ.includes('summary') || lowerQ.includes('tell me about')) {
                            response = `${product_info.name} is a ${product_info.development_phase} stage product for ${product_info.target_indication}. We are tracking ${patents.length} patents, ${clinical_trials.length} trials, and ${scientific_articles.length} articles.`;
                        }

                        setMessages(prev => [...prev, { role: 'ai', text: response }]);
                        setIsTyping(false);
                    }, 600);
                };

                const handleSend = () => {
                    if (!input.trim()) return;
                    setMessages(prev => [...prev, { role: 'user', text: input }]);
                    processQuery(input);
                    setInput('');
                };

                return (
                    <div className="fixed bottom-6 right-6 z-50 flex flex-col items-end pointer-events-none">
                        {/* Chat Window */}
                        {isOpen && (
                            <div className="bg-white rounded-xl shadow-2xl border border-slate-200 w-80 mb-4 overflow-hidden flex flex-col pointer-events-auto animate-in slide-in-from-bottom-5 fade-in duration-200">
                                <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-3 flex justify-between items-center text-white">
                                    <div className="flex items-center gap-2">
                                        <div className="bg-white/20 p-1.5 rounded-full"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2 2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z" /><path d="M12 16a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2z" /><path d="M5 8a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2z" /><path d="M19 8a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2z" /><rect x="8" y="8" width="8" height="8" rx="1" /></svg></div>
                                        <span className="font-bold text-sm">AI Assistant</span>
                                    </div>
                                    <button onClick={() => setIsOpen(false)} className="hover:bg-white/20 rounded p-1"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12" /></svg></button>
                                </div>
                                <div className="h-64 overflow-y-auto p-4 bg-slate-50 space-y-3">
                                    {messages.map((m, i) => (
                                        <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[85%] text-sm p-3 rounded-xl shadow-sm ${m.role === 'user' ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white border border-slate-200 text-slate-700 rounded-bl-none'}`}>
                                                {m.text}
                                            </div>
                                        </div>
                                    ))}
                                    {isTyping && (
                                        <div className="flex justify-start">
                                            <div className="bg-white border border-slate-200 text-slate-400 text-xs p-3 rounded-xl rounded-bl-none italic">
                                                Thinking...
                                            </div>
                                        </div>
                                    )}
                                    <div ref={messagesEndRef} />
                                </div>
                                <div className="p-3 bg-white border-t border-slate-200">
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            className="flex-1 text-sm border-slate-200 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                            placeholder="Ask me anything..."
                                            value={input}
                                            onChange={(e) => setInput(e.target.value)}
                                            onKeyDown={(e) => e.key === 'Enter' && handleSend()}
                                        />
                                        <button onClick={handleSend} className="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-lg transition-colors">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" /></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* FAB */}
                        <button
                            onClick={() => setIsOpen(!isOpen)}
                            className="bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all hover:scale-105 active:scale-95 pointer-events-auto"
                        >
                            {isOpen ? (
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12" /></svg>
                            ) : (
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2 2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z" /><path d="M12 16a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2z" /><path d="M5 8a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2z" /><path d="M19 8a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2z" /><rect x="8" y="8" width="8" height="8" rx="1" /></svg>
                            )}
                        </button>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-slate-50 pb-20 relative">
                    <AIAssistant />
                    {/* Header */}
                    <div className="bg-white border-b border-slate-200 sticky top-0 z-10">
                        <div className="container mx-auto px-4 py-4 flex items-center gap-4">
                            <button onClick={onBack} className="p-2 hover:bg-slate-100 rounded-lg text-slate-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6" /></svg>
                            </button>
                            <div className="flex-1">
                                <div className="flex items-center gap-3">
                                    <h1 className="text-2xl font-bold text-slate-900">{product_info.name}</h1>
                                    <Badge color="green">{product_info.development_phase}</Badge>
                                </div>
                                <p className="text-sm text-slate-500">{product_info.target_indication}</p>
                            </div>
                            {/* Alert Subscription Button */}
                            <button
                                onClick={toggleSubscription}
                                className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm transition-colors ${isSubscribed
                                    ? 'bg-amber-100 text-amber-700 hover:bg-amber-200'
                                    : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                    }`}
                            >
                                {isSubscribed ? 'üîî Subscribed' : 'üîï Get Alerts'}
                            </button>

                            {/* Download PDF Button */}
                            <button
                                onClick={() => window.open(`/products/${productId}/dossier`, '_blank')}
                                className="flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm transition-colors bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 hover:text-red-600"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><path d="M12 18v-6" /><path d="m9 15 3 3 3-3" /></svg>
                                PDF Report
                            </button>
                        </div>
                        {/* Tabs */}
                        <div className="container mx-auto px-4 mt-4 flex gap-6 overflow-x-auto">
                            {[
                                { id: 'overview', label: 'Overview', icon: 'layout' },
                                ...((patents && patents.length > 0) ? [{ id: 'patents', label: 'Patents', icon: 'scroll' }] : []),
                                ...((scientific_articles && scientific_articles.length > 0) ? [{ id: 'science', label: 'Articles', icon: 'file-text' }] : []),
                                ...((conferences && conferences.length > 0) ? [{ id: 'conferences', label: 'Conferences', icon: 'mic' }] : []),
                                ...((data.milestones && data.milestones.length > 0) ? [{ id: 'timeline', label: 'Timeline', icon: 'flag' }] : []),
                                ...((product_info.moa_video_url) ? [{ id: 'moa', label: 'MOA', icon: 'dna' }] : []),
                                ...((pharmacodynamics && pharmacodynamics.length > 0) ? [{ id: 'preclinical', label: 'Preclinical', icon: 'microscope' }] : []),
                                ...((clinical_trials && clinical_trials.length > 0) ? [{ id: 'clinical', label: 'Clinical', icon: 'activity' }] : []),
                                ...((pharmacokinetics && pharmacokinetics.length > 0) ? [{ id: 'pk', label: 'ADME', icon: 'pill' }] : []),
                                // Conditionally add Synthesis tab (Small molecules + has data)
                                ...(!/(antibody|monoclonal|IgG|protein|peptide|CHO cell)/i.test(product_info.description) && synthesis && synthesis.length > 0 ? [{ id: 'synthesis', label: 'Synthesis', icon: 'flask-conical' }] : []),
                                ...((experimental_models && experimental_models.length > 0) ? [{ id: 'experimental_models', label: 'Models', icon: 'flask-round' }] : []),
                            ].map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium transition-all whitespace-nowrap ${activeTab === tab.id
                                        ? 'bg-slate-900 text-white shadow-md transform scale-105'
                                        : 'bg-white text-slate-600 hover:bg-slate-100 border border-slate-200 hover:border-slate-300'
                                        }`}
                                >
                                    {/* Icon rendering logic provided by lucide.createIcons() but we need to use the i tag for lucide to pick it up or LucideReact if available. Since this is likely vanilla-ish React without LucideReact components imported, we might need a helper or just emojis if lucide isn't set up for dynamic icons easily.
                                        Looking at the file context, I see `lucide.createIcons()` in useEffect. So I should render <i data-lucide={tab.icon}/> 
                                        However, lucide.createIcons() runs once. Better to usage SVG or emojis if re-rendering is frequent, OR use the existing pattern.
                                        Wait, existing code uses `lucide.createIcons()` in `useEffect`. If I inject new `i` tags, I might need to re-run `lucide.createIcons()`. 
                                        Actually, simpler to use Emojis for "Visual" request if I can't easily rely on Lucide re-running, OR I can use the same SVGs I used in Quick Access if I copy them.
                                        Let's stick to the high-quality emojis used in Quick Access for consistency and reliability, or simpler SVGs.
                                        The user liked the "Quick Access" look. Let's replicate that style but horizontal.
                                        Actually, the previous Quick Access had Emojis. Let's use Emojis for instant visual impact.
                                        Overview: üìä, Patents: üìú, Science: üìÑ, Conferences: üé§, Timeline: üìÖ, MOA: üß¨, Preclinical: üî¨, Clinical: üè•, ADME: üíä, Synthesis: üß™, Models: üß´
                                     */}
                                    <span>{
                                        tab.id === 'overview' ? 'üìä' :
                                            tab.id === 'patents' ? 'üìú' :
                                                tab.id === 'science' ? 'üìÑ' :
                                                    tab.id === 'conferences' ? 'üé§' :
                                                        tab.id === 'timeline' ? 'üìÖ' :
                                                            tab.id === 'moa' ? 'üß¨' :
                                                                tab.id === 'preclinical' ? 'üî¨' :
                                                                    tab.id === 'clinical' ? 'üè•' :
                                                                        tab.id === 'pk' ? 'üíä' :
                                                                            tab.id === 'synthesis' ? '‚öóÔ∏è' :
                                                                                tab.id === 'experimental_models' ? 'üß´' : ''
                                    }</span>
                                    {tab.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Content */}
                    <div className="container mx-auto px-4 py-8">

                        {activeTab === 'overview' && (
                            <div className="space-y-6">


                                {/* Product Summary Card */}
                                <div className="bg-gradient-to-br from-slate-50 via-white to-accent/5 p-6 rounded-xl border border-slate-200 shadow-sm">
                                    <h2 className="text-xl font-bold text-slate-900 mb-4">Product Summary</h2>

                                    {/* Podcast-Style Narrative */}
                                    <div className="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-lg border border-indigo-100 mb-6">
                                        <div className="flex items-center justify-between mb-3">
                                            <div className="flex items-center gap-2">
                                                <span className="text-2xl">üéôÔ∏è</span>
                                                <h3 className="font-bold text-indigo-900">Intelligence Briefing</h3>
                                            </div>
                                            <button
                                                onClick={playBriefing}
                                                className={`flex items-center gap-2 px-4 py-2 rounded-full font-medium text-sm transition-all ${isPlaying
                                                    ? 'bg-red-500 text-white animate-pulse'
                                                    : 'bg-indigo-600 text-white hover:bg-indigo-700'
                                                    }`}
                                            >
                                                {isPlaying ? (
                                                    <>‚èπÔ∏è Stop Audio</>
                                                ) : (
                                                    <>‚ñ∂Ô∏è Listen to Briefing</>
                                                )}
                                            </button>
                                        </div>
                                        <p className="text-sm text-slate-700 leading-relaxed">
                                            <strong>{product_info.name}</strong> is a {product_info.development_phase?.toLowerCase() === 'approved' ? 'commercially launched' : 'pipeline'} therapeutic
                                            {product_info.description?.toLowerCase().includes('antibody') ? ' biologic (monoclonal antibody)' :
                                                product_info.description?.toLowerCase().includes('peptide') || product_info.description?.toLowerCase().includes('glp-1') ? ' peptide-based drug' :
                                                    ' small molecule drug'}
                                            targeting <strong>{product_info.target_indication}</strong>.
                                        </p>
                                        <p className="text-sm text-slate-700 leading-relaxed mt-2">
                                            üìä <strong>Clinical Evidence:</strong> Supported by <strong>{clinical_trials.length}</strong> registered clinical trials
                                            and <strong>{scientific_articles.length}</strong> peer-reviewed publications documenting its efficacy and safety profile.
                                        </p>
                                        <p className="text-sm text-slate-700 leading-relaxed mt-2">
                                            üíä <strong>Mechanism:</strong> {product_info.description}
                                        </p>
                                        <p className="text-sm text-slate-700 leading-relaxed mt-2">
                                            üè• <strong>Therapeutic Applications:</strong> Currently {data.indications?.length > 0 ?
                                                `indicated for ${data.indications.map(i => i.disease).join(', ')}` :
                                                'under investigation for multiple indications'}.
                                            {data.side_effects?.length > 0 &&
                                                ` Key safety considerations include ${data.side_effects.slice(0, 3).join(', ')}.`}
                                        </p>
                                        <p className="text-sm text-slate-700 leading-relaxed mt-2">
                                            üìú <strong>IP Landscape:</strong> Protected by <strong>{patents.length}</strong> patents
                                            covering {patents.some(p => p.patent_type === 'Product') ? 'composition of matter, ' : ''}
                                            {patents.some(p => p.patent_type === 'Use') ? 'methods of use, ' : ''}
                                            {patents.some(p => p.patent_type === 'Combination') ? 'combination therapies' : 'various claims'}.
                                        </p>
                                        <p className="text-sm text-slate-700 leading-relaxed mt-2">
                                            üé§ <strong>Conference Presence:</strong> Featured in <strong>{conferences.length}</strong> conference presentations
                                            at major medical meetings, demonstrating ongoing research interest and clinical development activity.
                                        </p>
                                    </div>

                                    {/* Description */}
                                    <p className="text-slate-600 mb-6 leading-relaxed">
                                        {product_info.description}
                                    </p>

                                    {/* Indications */}
                                    <div className="mb-4">
                                        <h3 className="text-sm font-bold text-slate-500 uppercase mb-2">Indications</h3>
                                        <div className="flex flex-wrap gap-2">
                                            {(data.indications || []).map((ind, idx) => (
                                                <span key={idx} className="px-3 py-1 bg-emerald-50 text-emerald-700 rounded-full text-sm font-medium border border-emerald-100">
                                                    {ind.disease} <span className="text-xs opacity-70">({ind.status})</span>
                                                </span>
                                            ))}
                                            {(!data.indications || data.indications.length === 0) && (
                                                <span className="text-slate-400 italic text-sm">No indications data.</span>
                                            )}
                                        </div>
                                    </div>

                                    {/* Side Effects */}
                                    <div className="mb-6">
                                        <h3 className="text-sm font-bold text-slate-500 uppercase mb-2">Key Side Effects</h3>
                                        <div className="flex flex-wrap gap-2">
                                            {(data.side_effects || []).slice(0, 6).map((e, idx) => (
                                                <span key={idx} className="px-2 py-0.5 bg-red-50 text-red-600 rounded text-xs border border-red-100">{e}</span>
                                            ))}
                                        </div>
                                    </div>




                                    {/* Quick Navigation Links */}
                                    <div className="border-t border-slate-200 pt-4">
                                        <h3 className="text-sm font-bold text-slate-500 uppercase mb-3">Quick Access</h3>
                                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2">
                                            {patents && patents.length > 0 && (
                                                <button onClick={() => setActiveTab('patents')} className="flex items-center gap-2 px-3 py-2 bg-purple-50 hover:bg-purple-100 rounded-lg text-purple-700 text-sm font-medium transition-colors">
                                                    üìú Patents ({patents.length})
                                                </button>
                                            )}
                                            {scientific_articles && scientific_articles.length > 0 && (
                                                <button onClick={() => setActiveTab('science')} className="flex items-center gap-2 px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded-lg text-blue-700 text-sm font-medium transition-colors">
                                                    üìÑ Articles ({scientific_articles.length})
                                                </button>
                                            )}
                                            {conferences && conferences.length > 0 && (
                                                <button onClick={() => setActiveTab('conferences')} className="flex items-center gap-2 px-3 py-2 bg-indigo-50 hover:bg-indigo-100 rounded-lg text-indigo-700 text-sm font-medium transition-colors">
                                                    üé§ Conferences ({conferences.length})
                                                </button>
                                            )}
                                            {data.milestones && data.milestones.length > 0 && (
                                                <button onClick={() => setActiveTab('timeline')} className="flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-700 text-sm font-medium transition-colors">
                                                    üìÖ Timeline
                                                </button>
                                            )}
                                            {product_info.moa_video_url && (
                                                <button onClick={() => setActiveTab('moa')} className="flex items-center gap-2 px-3 py-2 bg-pink-50 hover:bg-pink-100 rounded-lg text-pink-700 text-sm font-medium transition-colors">
                                                    üß¨ MOA
                                                </button>
                                            )}
                                            {pharmacodynamics && pharmacodynamics.length > 0 && (
                                                <button onClick={() => setActiveTab('preclinical')} className="flex items-center gap-2 px-3 py-2 bg-red-50 hover:bg-red-100 rounded-lg text-red-700 text-sm font-medium transition-colors">
                                                    üî¨ Preclinical
                                                </button>
                                            )}
                                            {clinical_trials && clinical_trials.length > 0 && (
                                                <button onClick={() => setActiveTab('clinical')} className="flex items-center gap-2 px-3 py-2 bg-green-50 hover:bg-green-100 rounded-lg text-green-700 text-sm font-medium transition-colors">
                                                    üè• Clinical ({clinical_trials.length})
                                                </button>
                                            )}
                                            {pharmacokinetics && pharmacokinetics.length > 0 && (
                                                <button onClick={() => setActiveTab('pk')} className="flex items-center gap-2 px-3 py-2 bg-orange-50 hover:bg-orange-100 rounded-lg text-orange-700 text-sm font-medium transition-colors">
                                                    üíä ADME
                                                </button>
                                            )}
                                            {!/(antibody|monoclonal|IgG|protein|peptide|CHO cell)/i.test(product_info.description) && synthesis && synthesis.length > 0 && (
                                                <button onClick={() => setActiveTab('synthesis')} className="flex items-center gap-2 px-3 py-2 bg-amber-50 hover:bg-amber-100 rounded-lg text-amber-700 text-sm font-medium transition-colors">
                                                    üß™ Synthesis
                                                </button>
                                            )}
                                            {experimental_models && experimental_models.length > 0 && (
                                                <button onClick={() => setActiveTab('experimental_models')} className="flex items-center gap-2 px-3 py-2 bg-teal-50 hover:bg-teal-100 rounded-lg text-teal-700 text-sm font-medium transition-colors">
                                                    üß´ Models
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>


                            </div>
                        )}

                        {/* New Timeline Tab */}
                        {activeTab === 'timeline' && (
                            <div className="space-y-6">
                                <Card title="Development Timeline" icon="activity">
                                    <div className="relative border-l-2 border-slate-200 ml-3 space-y-8 py-2">
                                        {(data.milestones || [])
                                            .sort((a, b) => new Date(a.date) - new Date(b.date))
                                            .map((item, idx) => (
                                                <div key={idx} className="relative pl-8">
                                                    <div className="absolute -left-[9px] top-1 h-4 w-4 rounded-full bg-white border-2 border-accent"></div>
                                                    <div className="text-xs text-slate-400 mb-1">{new Date(item.date).toLocaleDateString()}</div>
                                                    <h4 className="font-medium text-slate-800">{item.event}</h4>
                                                    <Badge color={item.phase === 'Approved' ? 'green' : item.phase?.includes('Phase') ? 'blue' : 'gray'}>{item.phase}</Badge>
                                                </div>
                                            ))}
                                        {(!data.milestones || data.milestones.length === 0) && (
                                            <div className="text-slate-400 italic text-sm pl-8">No development milestones available.</div>
                                        )}
                                    </div>
                                </Card>
                            </div>
                        )}

                        {/* Mechanism of Action Tab */}
                        {activeTab === 'moa' && (
                            <div className="container mx-auto px-4 py-8 max-w-7xl animate-in fade-in slide-in-from-bottom-4 duration-500">
                                {product_info.moa_video_url ? (
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                        <SectionHeader icon="play" title="Mechanism of Action" color="text-indigo-600" />
                                        <div className="aspect-video w-full rounded-lg overflow-hidden bg-slate-100">
                                            {product_info.moa_video_url.includes('.png') || product_info.moa_video_url.includes('.jpg') ? (
                                                <img
                                                    src={product_info.moa_video_url}
                                                    alt="Mechanism of Action Illustration"
                                                    className="w-full h-full object-cover hover:scale-105 transition-transform duration-700"
                                                />
                                            ) : (
                                                <iframe
                                                    width="100%"
                                                    height="100%"
                                                    src={product_info.moa_video_url}
                                                    title="MOA Video"
                                                    frameBorder="0"
                                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                                    allowFullScreen
                                                ></iframe>
                                            )}
                                        </div>
                                        <div className="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-100">
                                            <h4 className="text-sm font-bold text-slate-700 mb-2">Description</h4>
                                            <p className="text-slate-600 leading-relaxed">{product_info.description}</p>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center py-12">
                                        <div className="text-6xl mb-4">üß¨</div>
                                        <h3 className="text-xl font-bold text-slate-700">No Visual Content Available</h3>
                                        <p className="text-slate-500">Mechanism of action visual data is not currently available for this product.</p>
                                    </div>
                                )}
                            </div>
                        )}



                        {/* Preclinical & Pharmacology Tab */}
                        {/* Preclinical Data (Pharmacodynamics) Tab */}
                        {activeTab === 'preclinical' && (
                            <div className="container mx-auto px-4 py-8 max-w-7xl animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <div className="space-y-6">
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                        <SectionHeader icon="microscope" title="Preclinical Pharmacology (In Vitro)" color="text-red-600" />
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left">
                                                <thead className="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-100">
                                                    <tr>
                                                        <th className="px-4 py-3 font-medium">Parameter</th>
                                                        <th className="px-4 py-3 font-medium">Value</th>
                                                        <th className="px-4 py-3 font-medium">Unit</th>
                                                        <th className="px-4 py-3 font-medium">Target / Context</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {pharmacodynamics && pharmacodynamics.length > 0 ? (
                                                        pharmacodynamics.map((pd, i) => (
                                                            <tr key={i} className="border-b border-slate-50 last:border-0 hover:bg-slate-50/50">
                                                                <td className="px-4 py-3 font-medium text-slate-900">{pd.parameter}</td>
                                                                <td className="px-4 py-3 text-slate-700">{pd.value}</td>
                                                                <td className="px-4 py-3 text-slate-500">{pd.unit}</td>
                                                                <td className="px-4 py-3 text-slate-500">{pd.target}</td>
                                                            </tr>
                                                        ))
                                                    ) : (
                                                        <tr><td colSpan="4" className="px-4 py-8 text-center text-slate-400">No preclinical pharmacology data available.</td></tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Pharmacokinetics (ADME) Tab */}
                        {activeTab === 'pk' && (
                            <div className="container mx-auto px-4 py-8 max-w-7xl animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <div className="space-y-6">
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                        <SectionHeader icon="activity" title="Pharmacokinetic Data (ADME)" color="text-emerald-600" />
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left">
                                                <thead className="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-100">
                                                    <tr>
                                                        <th className="px-4 py-3 font-medium">Parameter</th>
                                                        <th className="px-4 py-3 font-medium">Value</th>
                                                        <th className="px-4 py-3 font-medium">Unit / Note</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {pharmacokinetics && pharmacokinetics.length > 0 ? (
                                                        pharmacokinetics.map((pk, i) => (
                                                            <tr key={i} className="border-b border-slate-50 last:border-0 hover:bg-slate-50/50">
                                                                <td className="px-4 py-3 font-medium text-slate-900">{pk.parameter}</td>
                                                                <td className="px-4 py-3 text-slate-700">{pk.value}</td>
                                                                <td className="px-4 py-3 text-slate-500">{pk.unit}</td>
                                                            </tr>
                                                        ))
                                                    ) : (
                                                        <tr><td colSpan="3" className="px-4 py-8 text-center text-slate-400">No pharmacokinetic data available.</td></tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Experimental Models Tab */}
                        {activeTab === 'experimental_models' && (
                            <div className="container mx-auto px-4 py-8 max-w-7xl animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <div className="space-y-6">
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                        <SectionHeader icon="flask" title="Experimental Models" color="text-violet-600" />
                                        <div className="space-y-4">
                                            {experimental_models && experimental_models.length > 0 ? (
                                                experimental_models.map((model, i) => (
                                                    <div key={i} className="p-4 bg-slate-50 rounded-lg border border-slate-100">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <h4 className="font-semibold text-slate-900">{model.model_name}</h4>
                                                            <Badge color="violet">{model.model_type}</Badge>
                                                        </div>
                                                        <p className="text-sm text-slate-600 leading-relaxed">{model.description}</p>
                                                    </div>
                                                ))
                                            ) : (
                                                <div className="text-center py-8 text-slate-400">No experimental models data available.</div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'clinical' && (
                            <div className="space-y-6 animate-in fade-in">
                                {/* Clinical Filters Bar */}
                                <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row gap-4 items-center justify-between">
                                    <h3 className="font-bold text-slate-700 flex items-center gap-2">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                                        Filters
                                    </h3>
                                    <div className="flex flex-wrap gap-4 w-full md:w-auto">
                                        {/* Year Filter */}
                                        <select
                                            className="px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-accent/50"
                                            value={clinicalFilters.year}
                                            onChange={(e) => setClinicalFilters(prev => ({ ...prev, year: e.target.value }))}
                                        >
                                            <option value="">All Years</option>
                                            {[...new Set(clinical_trials.map(t => t.start_date ? new Date(t.start_date).getFullYear() : ''))].filter(Boolean).sort().map(y => (
                                                <option key={y} value={y}>{y}</option>
                                            ))}
                                        </select>
                                        {/* Sponsor Filter */}
                                        <select
                                            className="px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-accent/50 max-w-[200px]"
                                            value={clinicalFilters.sponsor}
                                            onChange={(e) => setClinicalFilters(prev => ({ ...prev, sponsor: e.target.value }))}
                                        >
                                            <option value="">All Sponsors</option>
                                            {[...new Set(clinical_trials.map(t => t.sponsor).filter(Boolean))].sort().map((s, i) => (
                                                <option key={i} value={s}>{s}</option>
                                            ))}
                                        </select>
                                        {/* Disease Filter */}
                                        <select
                                            className="px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-accent/50 max-w-[200px]"
                                            value={clinicalFilters.disease}
                                            onChange={(e) => setClinicalFilters(prev => ({ ...prev, disease: e.target.value }))}
                                        >
                                            <option value="">All Indications</option>
                                            {[...new Set(product_info.target_indication?.split(', ').map(d => d.trim()))].map((d, i) => (
                                                <option key={i} value={d}>{d}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>

                                {/* Phase Distribution Bar */}
                                <div className="bg-white p-4 rounded-xl border border-slate-200">
                                    <h4 className="text-sm font-bold text-slate-700 mb-3">Phase Distribution</h4>
                                    <div className="flex gap-1 h-6 rounded-lg overflow-hidden">
                                        {['Phase 1', 'Phase 2', 'Phase 3', 'Phase 4'].map((phase, idx) => {
                                            const count = clinical_trials.filter(t => t.phase?.includes(phase.split(' ')[1])).length;
                                            const pct = clinical_trials.length > 0 ? (count / clinical_trials.length) * 100 : 0;
                                            const colors = ['bg-blue-400', 'bg-green-400', 'bg-purple-400', 'bg-amber-400'];
                                            return pct > 0 ? (
                                                <div key={phase} className={`${colors[idx]} flex items-center justify-center text-white text-xs font-bold`} style={{ width: `${Math.max(pct, 10)}%` }}>
                                                    {phase.split(' ')[1]}
                                                </div>
                                            ) : null;
                                        })}
                                    </div>
                                    <div className="flex justify-between text-xs text-slate-400 mt-2">
                                        <span>Early Phase</span>
                                        <span>Late Phase</span>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <Card className="md:col-span-3">
                                        <h3 className="text-lg font-bold mb-4">FDA Clinical Landscape</h3>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left">
                                                <thead className="text-xs text-slate-500 uppercase bg-slate-50">
                                                    <tr>
                                                        <th className="px-4 py-3">Status</th>
                                                        <th className="px-4 py-3">Phase</th>
                                                        <th className="px-4 py-3">Title</th>
                                                        <th className="px-4 py-3">Sponsor</th>
                                                        <th className="px-4 py-3">Start Year</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {clinical_trials
                                                        .filter(t => {
                                                            if (clinicalFilters.year && (!t.start_date || new Date(t.start_date).getFullYear().toString() !== clinicalFilters.year)) return false;
                                                            if (clinicalFilters.sponsor && t.sponsor !== clinicalFilters.sponsor) return false;
                                                            if (clinicalFilters.disease && !t.title.toLowerCase().includes(clinicalFilters.disease.toLowerCase())) return false;
                                                            return true;
                                                        })
                                                        .map(t => (
                                                            <tr key={t.id} className="border-b border-slate-100 hover:bg-slate-50">
                                                                <td className="px-4 py-3"><Badge color={t.status === 'Recruiting' ? 'green' : 'gray'}>{t.status}</Badge></td>
                                                                <td className="px-4 py-3 font-medium text-slate-700">{t.phase}</td>
                                                                <td className="px-4 py-3 text-slate-600">{t.title}</td>
                                                                <td className="px-4 py-3 text-slate-500 text-xs">{t.sponsor || '-'}</td>
                                                                <td className="px-4 py-3 text-slate-500 text-xs">{t.start_date ? new Date(t.start_date).getFullYear() : '-'}</td>
                                                            </tr>
                                                        ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </Card>
                                </div>
                            </div>
                        )}

                        {activeTab === 'science' && (
                            <div className="space-y-4">
                                {/* Visual Summary Cards */}
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border border-blue-200 text-center">
                                        <div className="text-3xl font-bold text-blue-700">{scientific_articles.length}</div>
                                        <div className="text-xs text-blue-600 font-medium uppercase">Total Articles</div>
                                    </div>
                                    <div className="bg-gradient-to-br from-indigo-50 to-indigo-100 p-4 rounded-xl border border-indigo-200 text-center">
                                        <div className="text-3xl font-bold text-indigo-700">
                                            {scientific_articles.length > 0 ? new Date(scientific_articles[scientific_articles.length - 1]?.publication_date).getFullYear() : '-'}
                                        </div>
                                        <div className="text-xs text-indigo-600 font-medium uppercase">Latest Year</div>
                                    </div>
                                    <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border border-purple-200 text-center">
                                        <div className="text-3xl font-bold text-purple-700">üìñ</div>
                                        <div className="text-xs text-purple-600 font-medium uppercase">PubMed</div>
                                    </div>
                                    <div className="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-xl border border-emerald-200 text-center">
                                        <div className="text-3xl font-bold text-emerald-700">‚úì</div>
                                        <div className="text-xs text-emerald-600 font-medium uppercase">Peer-Reviewed</div>
                                    </div>
                                </div>
                                {/* Publication Timeline */}
                                <div className="bg-white p-4 rounded-xl border border-slate-200">
                                    <h4 className="text-sm font-bold text-slate-700 mb-3">üìä Research Focus Areas</h4>
                                    <div className="flex flex-wrap gap-2">
                                        <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">Clinical Efficacy</span>
                                        <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">Mechanism of Action</span>
                                        <span className="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm">Safety Profile</span>
                                        <span className="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-sm">Pharmacokinetics</span>
                                    </div>
                                </div>

                                {/* Filters */}
                                <div className="flex flex-col md:flex-row gap-4 bg-white p-4 rounded-xl border border-slate-200">
                                    <div className="flex-1">
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Year</label>
                                        <select
                                            className="w-full text-sm border-slate-200 rounded-lg p-2"
                                            value={scienceFilters.year}
                                            onChange={(e) => setScienceFilters({ ...scienceFilters, year: e.target.value })}
                                        >
                                            <option value="">All Years</option>
                                            {[...new Set(scientific_articles.map(a => new Date(a.publication_date).getFullYear()))].sort().reverse().map(y => (
                                                <option key={y} value={y}>{y}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="flex-1">
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Company (Inferred)</label>
                                        <select
                                            className="w-full text-sm border-slate-200 rounded-lg p-2"
                                            value={scienceFilters.company}
                                            onChange={(e) => setScienceFilters({ ...scienceFilters, company: e.target.value })}
                                        >
                                            <option value="">All Companies</option>
                                            {[...new Set(patents.map(p => p.assignee).filter(Boolean))].sort().map((c, i) => (
                                                <option key={i} value={c}>{c}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="flex-1">
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Disease / Topic</label>
                                        <select
                                            className="w-full text-sm border-slate-200 rounded-lg p-2"
                                            value={scienceFilters.disease}
                                            onChange={(e) => setScienceFilters({ ...scienceFilters, disease: e.target.value })}
                                        >
                                            <option value="">All Topics</option>
                                            {[...new Set(patents.flatMap(p => p.diseases_in_claims ? p.diseases_in_claims.split(',').map(d => d.trim()) : []).filter(Boolean))].sort().map((d, i) => (
                                                <option key={i} value={d}>{d}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>

                                {scientific_articles
                                    .filter(a => {
                                        if (scienceFilters.year && new Date(a.publication_date).getFullYear().toString() !== scienceFilters.year) return false;
                                        if (scienceFilters.company) {
                                            const search = scienceFilters.company.toLowerCase();
                                            // Check abstract or title for company name mention
                                            const content = (a.title + " " + (a.abstract || "")).toLowerCase();
                                            if (!content.includes(search)) return false;
                                        }
                                        if (scienceFilters.disease) {
                                            const search = scienceFilters.disease.toLowerCase();
                                            if (!a.title.toLowerCase().includes(search) && !a.abstract?.toLowerCase().includes(search)) return false;
                                        }
                                        return true;
                                    })
                                    .map(a => (
                                        <Card key={a.id} className="hover:border-accent/50 transition-colors">
                                            <div className="flex gap-4">
                                                <div className="flex-1">
                                                    <h4 className="text-lg font-semibold text-slate-900 mb-1">{a.title}</h4>
                                                    <div className="text-sm text-slate-500 mb-3">{a.authors} ‚Ä¢ {new Date(a.publication_date).getFullYear()}</div>
                                                    <div className="mb-3">
                                                        <h5 className="text-xs font-bold text-slate-400 uppercase mb-1">Abstract</h5>
                                                        <p className="text-sm text-slate-600 leading-relaxed bg-slate-50 p-3 rounded-lg">{a.abstract || 'No abstract available.'}</p>
                                                    </div>
                                                    <a href={a.url} target="_blank" className="text-sm font-medium text-accent hover:underline flex items-center gap-1">
                                                        Read Full Article <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></svg>
                                                    </a>
                                                </div>
                                            </div>
                                        </Card>
                                    ))}
                            </div>
                        )}

                        {activeTab === 'patents' && (
                            <div className="space-y-4">
                                {/* Visual Summary Cards - Click to Filter */}
                                <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                                    <div
                                        onClick={() => setPatentFilters({ ...patentFilters, type: 'all' })}
                                        className={`cursor-pointer transition-all p-4 rounded-xl border text-center ${patentFilters.type === 'all' ? 'bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200 ring-2 ring-purple-500 ring-offset-2' : 'bg-white border-slate-200 hover:border-purple-200 hover:bg-purple-50/50'}`}
                                    >
                                        <div className="text-3xl font-bold text-purple-700">{patents.length}</div>
                                        <div className="text-xs text-purple-600 font-medium uppercase">Total Patents</div>
                                    </div>
                                    <div
                                        onClick={() => setPatentFilters({ ...patentFilters, type: 'Product' })}
                                        className={`cursor-pointer transition-all p-4 rounded-xl border text-center ${patentFilters.type === 'Product' ? 'bg-gradient-to-br from-indigo-50 to-indigo-100 border-indigo-200 ring-2 ring-indigo-500 ring-offset-2' : 'bg-white border-slate-200 hover:border-indigo-200 hover:bg-indigo-50/50'}`}
                                    >
                                        <div className="text-3xl font-bold text-indigo-700">{patents.filter(p => p.patent_type === 'Product').length}</div>
                                        <div className="text-xs text-indigo-600 font-medium uppercase">üì¶ Product</div>
                                    </div>
                                    <div
                                        onClick={() => setPatentFilters({ ...patentFilters, type: 'Use' })}
                                        className={`cursor-pointer transition-all p-4 rounded-xl border text-center ${patentFilters.type === 'Use' ? 'bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200 ring-2 ring-blue-500 ring-offset-2' : 'bg-white border-slate-200 hover:border-blue-200 hover:bg-blue-50/50'}`}
                                    >
                                        <div className="text-3xl font-bold text-blue-700">{patents.filter(p => p.patent_type === 'Use').length}</div>
                                        <div className="text-xs text-blue-600 font-medium uppercase">üíä Use</div>
                                    </div>
                                    <div
                                        onClick={() => setPatentFilters({ ...patentFilters, type: 'Combination' })}
                                        className={`cursor-pointer transition-all p-4 rounded-xl border text-center ${patentFilters.type === 'Combination' ? 'bg-gradient-to-br from-amber-50 to-amber-100 border-amber-200 ring-2 ring-amber-500 ring-offset-2' : 'bg-white border-slate-200 hover:border-amber-200 hover:bg-amber-50/50'}`}
                                    >
                                        <div className="text-3xl font-bold text-amber-700">{patents.filter(p => p.patent_type === 'Combination').length}</div>
                                        <div className="text-xs text-amber-600 font-medium uppercase">üîó Combination</div>
                                    </div>
                                    <div
                                        onClick={() => setPatentFilters({ ...patentFilters, type: 'Granted' })}
                                        className={`cursor-pointer transition-all p-4 rounded-xl border text-center ${patentFilters.type === 'Granted' ? 'bg-gradient-to-br from-green-50 to-green-100 border-green-200 ring-2 ring-green-500 ring-offset-2' : 'bg-white border-slate-200 hover:border-green-200 hover:bg-green-50/50'}`}
                                    >
                                        <div className="text-3xl font-bold text-green-700">{patents.filter(p => p.status === 'Granted').length}</div>
                                        <div className="text-xs text-green-600 font-medium uppercase">‚úì Granted</div>
                                    </div>
                                </div>
                                {/* IP Sources Bar */}
                                <div className="bg-white p-4 rounded-xl border border-slate-200">
                                    <h4 className="text-sm font-bold text-slate-700 mb-3">üìä IP Coverage</h4>
                                    <div className="flex flex-wrap gap-2">
                                        <span className="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm">USPTO</span>
                                        <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">EPO</span>
                                        <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">Composition of Matter</span>
                                        <span className="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-sm">Methods of Use</span>
                                        <span className="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm">Manufacturing Process</span>
                                    </div>
                                </div>

                                {/* Filters */}
                                <div className="flex gap-4 bg-white p-4 rounded-xl border border-slate-200 flex-wrap">
                                    <div className="flex-1 min-w-[150px]">
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Company / Assignee</label>
                                        <select
                                            className="w-full text-sm border-slate-200 rounded-lg p-2"
                                            value={patentFilters.company}
                                            onChange={(e) => setPatentFilters({ ...patentFilters, company: e.target.value })}
                                        >
                                            <option value="">All Companies</option>
                                            {[...new Set(patents.map(p => p.assignee).filter(Boolean))].sort().map((c, i) => (
                                                <option key={i} value={c}>{c}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="flex-1 min-w-[150px]">
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Year</label>
                                        <select
                                            className="w-full text-sm border-slate-200 rounded-lg p-2"
                                            value={patentFilters.year}
                                            onChange={(e) => setPatentFilters({ ...patentFilters, year: e.target.value })}
                                        >
                                            <option value="">All Years</option>
                                            {[...new Set(patents.filter(p => p.publication_date).map(p => new Date(p.publication_date).getFullYear()))].sort().reverse().map(y => (
                                                <option key={y} value={y}>{y}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="flex-1 min-w-[150px]">
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Office</label>
                                        <select
                                            className="w-full text-sm border-slate-200 rounded-lg p-2"
                                            value={patentFilters.office}
                                            onChange={(e) => setPatentFilters({ ...patentFilters, office: e.target.value })}
                                        >
                                            <option value="">All Offices</option>
                                            <option value="US">USPTO (US)</option>
                                            <option value="EP">EPO (EP)</option>
                                            <option value="WO">WIPO (WO)</option>
                                        </select>
                                    </div>
                                    <div className="flex-1 min-w-[150px]">
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Disease</label>
                                        <select
                                            className="w-full text-sm border-slate-200 rounded-lg p-2"
                                            value={patentFilters.disease}
                                            onChange={(e) => setPatentFilters({ ...patentFilters, disease: e.target.value })}
                                        >
                                            <option value="">All Diseases</option>
                                            {[...new Set(patents.flatMap(p => p.diseases_in_claims ? p.diseases_in_claims.split(',').map(d => d.trim()) : []).filter(Boolean))].sort().map((d, i) => (
                                                <option key={i} value={d}>{d}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>

                                {patents
                                    .filter(p => {
                                        // Type/Status Filter (from visual cards)
                                        if (patentFilters.type !== 'all') {
                                            if (patentFilters.type === 'Granted') {
                                                if (p.status !== 'Granted') return false;
                                            } else {
                                                if (p.patent_type !== patentFilters.type) return false;
                                            }
                                        }

                                        // Advanced Filters
                                        if (patentFilters.company && p.assignee !== patentFilters.company) return false;
                                        if (patentFilters.year && (!p.publication_date || new Date(p.publication_date).getFullYear().toString() !== patentFilters.year)) return false;
                                        if (patentFilters.disease && (!p.diseases_in_claims || !p.diseases_in_claims.includes(patentFilters.disease))) return false;
                                        if (patentFilters.office && !p.source_id.startsWith(patentFilters.office)) return false;

                                        return true;
                                    })
                                    .map(p => (
                                        <div key={p.id} className="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                                            <div className="flex justify-between items-start mb-3">
                                                <div>
                                                    <div className="flex items-center gap-2 mb-1 flex-wrap">
                                                        <span className="font-mono text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-600">{p.source_id}</span>
                                                        <Badge color={p.patent_type === 'Product' ? 'purple' : p.patent_type === 'Use' ? 'blue' : p.patent_type === 'Combination' ? 'amber' : 'gray'}>
                                                            {p.patent_type === 'Product' && 'üì¶ Product Patent'}
                                                            {p.patent_type === 'Use' && 'üíä Use Patent'}
                                                            {p.patent_type === 'Combination' && 'üîó Combination Patent'}
                                                            {p.patent_type === 'Composition' && 'üß™ Composition Patent'}
                                                            {!p.patent_type && 'Unknown Type'}
                                                        </Badge>
                                                        <Badge color={p.status === 'Granted' ? 'green' : 'gray'}>{p.status || 'Active'}</Badge>
                                                    </div>
                                                    <h4 className="font-bold text-lg text-slate-900">{p.title}</h4>
                                                    <div className="flex items-center gap-3 text-sm text-slate-500 mt-1">
                                                        <span>{p.assignee}</span>
                                                        {p.publication_date && (
                                                            <span className="text-xs bg-slate-50 px-2 py-0.5 rounded">üìÖ Published: {new Date(p.publication_date).toLocaleDateString()}</span>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                            {p.abstract && (
                                                <div className="mb-4">
                                                    <h5 className="text-xs font-bold text-slate-400 uppercase mb-1">Abstract</h5>
                                                    <p className="text-sm text-slate-600">{p.abstract}</p>
                                                </div>
                                            )}
                                            {p.claim_summary && (
                                                <div className="mb-4 bg-blue-50 p-3 rounded-lg border border-blue-100">
                                                    <h5 className="text-xs font-bold text-blue-600 uppercase mb-1">Key Claims Summary</h5>
                                                    <p className="text-sm text-slate-700">{p.claim_summary}</p>
                                                </div>
                                            )}
                                            {p.diseases_in_claims && (
                                                <div className="mb-3">
                                                    <h5 className="text-xs font-bold text-slate-400 uppercase mb-2">Diseases in Claims</h5>
                                                    <div className="flex flex-wrap gap-1">
                                                        {p.diseases_in_claims.split(',').map((d, i) => (
                                                            <span key={i} className="px-2 py-0.5 bg-amber-50 text-amber-700 rounded text-xs border border-amber-100">{d.trim()}</span>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                            <a href={p.url} target="_blank" className="text-sm font-medium text-accent hover:underline">View Patent ‚Üí</a>
                                        </div>
                                    ))}
                                {patents.length === 0 && <p className="text-slate-400 italic">No patents found for this product.</p>}
                            </div>
                        )}

                        {activeTab === 'conferences' && (
                            <div className="space-y-4">
                                {/* Visual Summary Cards */}
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="bg-gradient-to-br from-indigo-50 to-indigo-100 p-4 rounded-xl border border-indigo-200 text-center">
                                        <div className="text-3xl font-bold text-indigo-700">{conferences.length}</div>
                                        <div className="text-xs text-indigo-600 font-medium uppercase">Total Presentations</div>
                                    </div>
                                    <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border border-purple-200 text-center">
                                        <div className="text-3xl font-bold text-purple-700">üé§</div>
                                        <div className="text-xs text-purple-600 font-medium uppercase">Oral & Posters</div>
                                    </div>
                                    <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border border-blue-200 text-center">
                                        <div className="text-3xl font-bold text-blue-700">
                                            {conferences.length > 0 ? new Set(conferences.map(c => c.conference_name)).size : 0}
                                        </div>
                                        <div className="text-xs text-blue-600 font-medium uppercase">Different Events</div>
                                    </div>
                                    <div className="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-xl border border-emerald-200 text-center">
                                        <div className="text-3xl font-bold text-emerald-700">
                                            {conferences.length > 0 ? new Date(conferences[conferences.length - 1]?.date).getFullYear() : '-'}
                                        </div>
                                        <div className="text-xs text-emerald-600 font-medium uppercase">Latest Year</div>
                                    </div>
                                </div>
                                {/* Major Conferences */}
                                <div className="bg-white p-4 rounded-xl border border-slate-200">
                                    <h4 className="text-sm font-bold text-slate-700 mb-3">üèõÔ∏è Major Medical Meetings</h4>
                                    <div className="flex flex-wrap gap-2">
                                        {[...new Set(conferences.map(c => c.conference_name))].slice(0, 6).map((conf, idx) => (
                                            <span key={idx} className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm">{conf}</span>
                                        ))}
                                    </div>
                                </div>

                                {/* Filters */}
                                <div className="flex gap-4 bg-white p-4 rounded-xl border border-slate-200 flex-wrap">
                                    <div className="flex-1 min-w-[150px]">
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Presentation Type</label>
                                        <select
                                            className="w-full text-sm border-slate-200 rounded-lg p-2"
                                            value={conferenceFilters.type}
                                            onChange={(e) => setConferenceFilters({ ...conferenceFilters, type: e.target.value })}
                                        >
                                            <option value="all">All Types</option>
                                            <option value="oral">Oral Presentation</option>
                                            <option value="poster">Poster</option>
                                        </select>
                                    </div>
                                    <div className="flex-1 min-w-[150px]">
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Company (Inferred)</label>
                                        <select
                                            className="w-full text-sm border-slate-200 rounded-lg p-2"
                                            value={conferenceFilters.company}
                                            onChange={(e) => setConferenceFilters({ ...conferenceFilters, company: e.target.value })}
                                        >
                                            <option value="">All Companies</option>
                                            {[...new Set(patents.map(p => p.assignee).filter(Boolean))].sort().map((c, i) => (
                                                <option key={i} value={c}>{c}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="flex-1 min-w-[150px]">
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Year</label>
                                        <select
                                            className="w-full text-sm border-slate-200 rounded-lg p-2"
                                            value={conferenceFilters.year}
                                            onChange={(e) => setConferenceFilters({ ...conferenceFilters, year: e.target.value })}
                                        >
                                            <option value="">All Years</option>
                                            {[...new Set(conferences.map(c => new Date(c.date).getFullYear()))].sort().reverse().map(y => (
                                                <option key={y} value={y}>{y}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="flex-1 min-w-[150px]">
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Disease / Topic</label>
                                        <select
                                            className="w-full text-sm border-slate-200 rounded-lg p-2"
                                            value={conferenceFilters.disease}
                                            onChange={(e) => setConferenceFilters({ ...conferenceFilters, disease: e.target.value })}
                                        >
                                            <option value="">All Topics</option>
                                            {[...new Set(patents.flatMap(p => p.diseases_in_claims ? p.diseases_in_claims.split(',').map(d => d.trim()) : []).filter(Boolean))].sort().map((d, i) => (
                                                <option key={i} value={d}>{d}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {conferences
                                        .filter(c => {
                                            // Advanced Filters
                                            if (conferenceFilters.year && new Date(c.date).getFullYear().toString() !== conferenceFilters.year) return false;

                                            // Text based filters (Disease, Company, Type) checks title and abstract
                                            const text = (c.title + ' ' + (c.abstract || '')).toLowerCase();

                                            if (conferenceFilters.disease && !text.includes(conferenceFilters.disease.toLowerCase())) return false;
                                            if (conferenceFilters.company && !text.includes(conferenceFilters.company.toLowerCase())) return false;

                                            if (conferenceFilters.type !== 'all') {
                                                if (conferenceFilters.type === 'oral' && !text.includes('oral') && !text.includes('presentation')) return false;
                                                if (conferenceFilters.type === 'poster' && !text.includes('poster')) return false;
                                            }

                                            return true;
                                        })
                                        .map(c => (
                                            <div key={c.id} className="bg-gradient-to-br from-indigo-50 to-white p-6 rounded-xl border border-indigo-100">
                                                <div className="flex justify-between items-start mb-2">
                                                    <div className="text-xs font-bold text-indigo-600 uppercase tracking-wide">{c.conference_name}</div>
                                                    <div className="text-xs text-slate-400">{new Date(c.date).toLocaleDateString()}</div>
                                                </div>
                                                <h4 className="font-bold text-slate-900 mb-3">{c.title}</h4>
                                                <div className="mb-3">
                                                    <h5 className="text-xs font-bold text-slate-400 uppercase mb-1">Abstract</h5>
                                                    <p className="text-sm text-slate-600 leading-relaxed bg-white/60 p-3 rounded-lg">{c.abstract || 'No abstract available.'}</p>
                                                </div>
                                            </div>
                                        ))}
                                </div>
                            </div>
                        )}

                        {/* Synthesis Tab */}
                        {activeTab === 'synthesis' && (
                            <div className="container mx-auto px-4 py-8 max-w-7xl animate-in fade-in slide-in-from-bottom-4 duration-500">
                                {/* Only show logic if small molecule */}
                                {!/(antibody|monoclonal|IgG|protein|peptide|CHO cell)/i.test(product_info.description) ? (
                                    <div className="space-y-6">
                                        <Card title="Chemical Synthesis & Manufacturing" icon="flask-conical">
                                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                                {/* Visual Reaction Scheme */}
                                                <div className="space-y-4">
                                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                                        <h3 className="text-sm font-bold text-slate-500 uppercase mb-4">Reaction Scheme</h3>
                                                        <div className="bg-white rounded-lg border border-slate-200 overflow-hidden shadow-sm">
                                                            {/* If Eliquis, show the specific generated image, else generic or empty */}
                                                            {product_info.name.includes('Eliquis') || product_info.name.includes('Apixaban') ? (
                                                                <img
                                                                    src="/app/assets/synthesis_scheme_apixaban.png"
                                                                    alt="Apixaban Synthesis Scheme"
                                                                    className="w-full h-auto object-contain p-2 hover:scale-105 transition-transform duration-500"
                                                                />
                                                            ) : (
                                                                <div className="p-12 text-center">
                                                                    <div className="text-6xl mb-4">‚öóÔ∏è</div>
                                                                    <p className="text-slate-400">Chemical structure visualization available for specific compounds.</p>
                                                                </div>
                                                            )}
                                                        </div>
                                                        <p className="text-xs text-slate-400 mt-2 text-center italic">
                                                            Figure 1: Synthetic pathway from starting materials to final active pharmaceutical ingredient.
                                                        </p>
                                                    </div>
                                                </div>

                                                {/* Step-by-Step Details */}
                                                <div className="space-y-4">
                                                    <h3 className="text-sm font-bold text-slate-500 uppercase mb-4">Step-by-Step Procedure</h3>
                                                    <div className="relative border-l-2 border-indigo-100 ml-3 space-y-6 py-2">
                                                        {data.synthesis_steps && data.synthesis_steps.length > 0 ? (
                                                            data.synthesis_steps.map((step, idx) => (
                                                                <div key={idx} className="relative pl-8 group">
                                                                    <div className="absolute -left-[9px] top-1 h-4 w-4 rounded-full bg-white border-2 border-indigo-500 group-hover:bg-indigo-50 transition-colors"></div>
                                                                    <h4 className="font-bold text-slate-800 text-sm mb-1">Step {idx + 1}</h4>
                                                                    <p className="text-slate-600 text-sm leading-relaxed bg-slate-50 p-3 rounded-lg border border-slate-100 group-hover:border-indigo-100 transition-colors">
                                                                        {step}
                                                                    </p>
                                                                </div>
                                                            ))
                                                        ) : (
                                                            <div className="pl-8 text-slate-400 italic">No detailed synthesis steps available for this compound.</div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </Card>
                                    </div>
                                ) : (
                                    <div className="flex flex-col items-center justify-center py-20 bg-slate-50 rounded-xl border border-dashed border-slate-300">
                                        <div className="text-6xl mb-4">üß¨</div>
                                        <h3 className="text-xl font-bold text-slate-700 mb-2">Biologic / Complex Molecule</h3>
                                        <p className="text-slate-500 text-center max-w-md">
                                            This product is a biological agent (e.g., antibody, peptide) produced via cell culture or fermentation,
                                            not via traditional chemical synthesis.
                                        </p>
                                        <button onClick={() => setActiveTab('overview')} className="mt-6 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                                            Return to Overview
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ChatView = () => {
            const [messages, setMessages] = useState([
                { role: 'system', text: 'Hello! I am your AI research assistant. Ask me about clinical trials, patents, or scientific articles. Try "Show me trials for Keytruda" or "Latest patents for Eliquis".' }
            ]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(scrollToBottom, [messages]);

            const handleSend = async (e) => {
                e.preventDefault();
                if (!input.trim()) return;

                const userMsg = { role: 'user', text: input };
                setMessages(prev => [...prev, userMsg]);
                setInput('');
                setLoading(true);

                try {
                    const res = await fetch('/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: userMsg.text })
                    });
                    const data = await res.json();

                    const botMsg = {
                        role: 'system',
                        text: data.text,
                        related_data: data.related_data
                    };
                    setMessages(prev => [...prev, botMsg]);
                } catch (e) {
                    setMessages(prev => [...prev, { role: 'system', text: "Sorry, I encountered an error processing your request." }]);
                }
                setLoading(false);
            };

            return (
                <div className="flex flex-col h-[calc(100vh-2rem)] max-w-5xl mx-auto p-4 animate-in fade-in duration-500">
                    <div className="flex-1 overflow-y-auto space-y-4 mb-4 pr-2 custom-scrollbar">
                        {messages.map((msg, idx) => (
                            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[80%] rounded-2xl p-4 ${msg.role === 'user'
                                    ? 'bg-slate-900 text-white rounded-tr-none'
                                    : 'bg-white border border-slate-200 shadow-sm rounded-tl-none'
                                    }`}>
                                    <div className="whitespace-pre-wrap text-sm leading-relaxed">{msg.text}</div>

                                    {/* Rich Cards for Data */}
                                    {msg.related_data && msg.related_data.length > 0 && (
                                        <div className="mt-4 space-y-2">
                                            {msg.related_data.map((item, i) => (
                                                <div key={i} className="bg-slate-50 p-3 rounded-lg border border-slate-100 text-xs">
                                                    <div className="flex justify-between items-start mb-1">
                                                        <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase ${item.type === 'Trial' ? 'bg-orange-100 text-orange-700' :
                                                            item.type === 'Patent' ? 'bg-purple-100 text-purple-700' :
                                                                'bg-blue-100 text-blue-700'
                                                            }`}>
                                                            {item.type}
                                                        </span>
                                                    </div>
                                                    <div className="font-bold text-slate-800 mb-1">{item.title}</div>
                                                    <div className="text-slate-500">{item.detail}</div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                        {loading && (
                            <div className="flex justify-start">
                                <div className="bg-white border border-slate-200 rounded-2xl p-4 rounded-tl-none flex items-center gap-2">
                                    <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></div>
                                    <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                                    <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    <form onSubmit={handleSend} className="relative">
                        <input
                            type="text"
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            placeholder="Ask about trials, patents, or scientific papers..."
                            className="w-full p-4 pr-12 rounded-xl border border-slate-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent transition-all"
                            disabled={loading}
                        />
                        <button
                            type="submit"
                            disabled={!input.trim() || loading}
                            className="absolute right-2 top-2 p-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <i data-lucide="send" className="w-5 h-5"></i>
                        </button>
                    </form>
                </div>
            );
        };

        const ComparisonView = () => {
            const [products, setProducts] = useState([]);
            const [selectedIds, setSelectedIds] = useState([]);
            const [comparisonData, setComparisonData] = useState(null);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                fetchProducts().then(setProducts);
            }, []);

            const handleCompare = async () => {
                if (selectedIds.length < 2) return;
                setLoading(true);
                try {
                    const query = selectedIds.map(id => `ids=${id}`).join('&');
                    const res = await fetch(`/products/compare?${query}`);
                    const data = await res.json();
                    setComparisonData(data);
                } catch (e) {
                    console.error("Comparison failed", e);
                }
                setLoading(false);
            };

            const toggleProduct = (id) => {
                if (selectedIds.includes(id)) {
                    setSelectedIds(selectedIds.filter(x => x !== id));
                } else {
                    if (selectedIds.length < 3) {
                        setSelectedIds([...selectedIds, id]);
                    }
                }
            };

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [products, selectedIds, comparisonData]);

            return (
                <div className="p-8 max-w-7xl mx-auto space-y-8 animate-in fade-in duration-500">
                    <div>
                        <h2 className="text-3xl font-bold text-slate-900 mb-2">Competitive Landscape</h2>
                        <p className="text-slate-500">Side-by-side product comparison.</p>
                    </div>

                    {/* Selector */}
                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 className="text-sm font-bold text-slate-700 uppercase mb-4">Select Products (Max 3)</h3>
                        <div className="flex flex-wrap gap-3 mb-6">
                            {products.map(p => (
                                <button
                                    key={p.id}
                                    onClick={() => toggleProduct(p.id)}
                                    className={`px-4 py-2 rounded-lg border text-sm font-medium transition-all flex items-center gap-2 ${selectedIds.includes(p.id)
                                        ? 'bg-accent text-white border-accent shadow-md'
                                        : 'bg-white text-slate-600 border-slate-200 hover:border-accent hover:text-accent'
                                        }`}
                                >
                                    {p.name}
                                    {selectedIds.includes(p.id) && <span>‚úì</span>}
                                </button>
                            ))}
                        </div>
                        <button
                            onClick={handleCompare}
                            disabled={selectedIds.length < 2 || loading}
                            className="bg-slate-900 text-white px-6 py-3 rounded-lg font-bold hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                        >
                            {loading ? 'Analyzing...' : 'Generate Comparison'}
                            <i data-lucide="arrow-right" className="w-4 h-4"></i>
                        </button>
                    </div>

                    {/* Results */}
                    {comparisonData && (
                        <div className="space-y-8 animate-in slide-in-from-bottom-8 duration-700">

                            {/* 1. Timeline */}
                            <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm overflow-x-auto">
                                <h3 className="text-lg font-bold text-slate-900 mb-6 flex items-center gap-2">
                                    <i data-lucide="bar-chart-2" className="w-5 h-5 text-accent"></i>
                                    Strategic Intelligence (Gantt View)
                                </h3>
                                <div className="min-w-[700px]">
                                    {/* X-Axis Scale */}
                                    <div className="flex text-xs font-bold text-slate-400 pl-32 mb-2 border-b border-slate-100 pb-2 relative h-6">
                                        {[2015, 2020, 2025, 2030, 2035].map(year => {
                                            const left = ((year - 2015) / (2035 - 2015)) * 100;
                                            return (
                                                <span key={year} className="absolute transform -translate-x-1/2" style={{ left: `${left}%` }}>
                                                    {year}
                                                </span>
                                            );
                                        })}
                                    </div>

                                    <div className="space-y-6">
                                        {selectedIds.map(id => {
                                            const prod = products.find(p => p.id === id);
                                            const events = comparisonData.timeline_events.filter(e => e.product === prod.name);
                                            const cliff = comparisonData.patent_cliffs.find(c => c.product === prod.name);

                                            return (
                                                <div key={id} className="relative group">
                                                    <div className="flex items-center mb-2">
                                                        <span className="w-32 font-bold text-slate-700 text-sm truncate pr-4">{prod.name}</span>
                                                        <div className="flex-1 h-32 bg-slate-50 rounded-lg relative border border-slate-100">

                                                            {/* Grid Lines */}
                                                            {[2020, 2025, 2030].map(year => (
                                                                <div key={year} className="absolute top-0 bottom-0 border-l border-slate-200 border-dashed"
                                                                    style={{ left: `${((year - 2015) / (2035 - 2015)) * 100}%` }}></div>
                                                            ))}

                                                            {/* Patent Cliff Line */}
                                                            {cliff && (
                                                                <div className="absolute top-0 bottom-0 w-0.5 bg-red-400 border-l-2 border-red-500 border-dotted z-10 flex flex-col items-center"
                                                                    style={{ left: `${((cliff.year - 2015) / (2035 - 2015)) * 100}%` }}>
                                                                    <div className="bg-red-500 text-white text-[10px] px-1 py-0.5 rounded mt-1 shadow-sm whitespace-nowrap">
                                                                        LoE {cliff.year}
                                                                    </div>
                                                                </div>
                                                            )}

                                                            {/* Gantt Bars */}
                                                            {events.map((ev, i) => {
                                                                if (ev.type !== 'Trial Start') return null;

                                                                const startYear = new Date(ev.date).getFullYear();
                                                                const endYear = ev.end_date ? new Date(ev.end_date).getFullYear() : startYear + 2;

                                                                const startPos = Math.max(0, ((startYear - 2015) / (2035 - 2015)) * 100);
                                                                const endPos = Math.min(100, ((endYear - 2015) / (2035 - 2015)) * 100);
                                                                const width = endPos - startPos;

                                                                const color = ev.phase.includes('3') ? 'bg-purple-500' :
                                                                    ev.phase.includes('2') ? 'bg-blue-400' : 'bg-slate-400';

                                                                return (
                                                                    <div
                                                                        key={i}
                                                                        className={`absolute h-4 rounded shadow-sm opacity-80 hover:opacity-100 transition-all cursor-help ${color}`}
                                                                        style={{
                                                                            left: `${startPos}%`,
                                                                            width: `${width}%`,
                                                                            top: `${(i % 3) * 25 + 10}px`
                                                                        }}
                                                                        title={`${ev.title} (${ev.phase}) 
Start: ${ev.date}`}
                                                                    ></div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                            </div>

                            {/* 2. PK Matrix */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                    <h3 className="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                                        <i data-lucide="activity" className="w-5 h-5 text-emerald-500"></i>
                                        PK Comparison
                                    </h3>
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-50 border-b border-slate-100 text-xs text-slate-500 uppercase">
                                            <tr>
                                                <th className="px-4 py-3">Parameter</th>
                                                {comparisonData.products.map(p => (
                                                    <th key={p.id} className="px-4 py-3">{p.name}</th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {Object.entries(comparisonData.pk_comparison).map(([param, values]) => (
                                                <tr key={param} className="hover:bg-slate-50">
                                                    <td className="px-4 py-3 font-medium text-slate-900">{param}</td>
                                                    {comparisonData.products.map(p => (
                                                        <td key={p.id} className="px-4 py-3 text-slate-600">
                                                            {values[p.name] || '-'}
                                                        </td>
                                                    ))}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                {/* 3. Patent Cliffs */}
                                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                    <h3 className="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                                        <i data-lucide="alert-triangle" className="w-5 h-5 text-red-500"></i>
                                        Patent Cliffs (Est.)
                                    </h3>
                                    <div className="space-y-4">
                                        {comparisonData.patent_cliffs.map((cliff, i) => (
                                            <div key={i} className="flex items-center justify-between p-4 bg-red-50 rounded-lg border border-red-100">
                                                <div>
                                                    <h4 className="font-bold text-red-900">{cliff.product}</h4>
                                                    <p className="text-xs text-red-600 mt-1">{cliff.notes}</p>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-2xl font-bold text-red-700">{cliff.year}</div>
                                                    <div className="text-xs text-red-500 uppercase font-medium">Expiry</div>
                                                </div>
                                            </div>
                                        ))}
                                        {comparisonData.patent_cliffs.length === 0 && <p className="text-slate-400 italic">No patent expiry data available.</p>}
                                    </div>
                                </div>
                            </div>

                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [selectedProductId, setSelectedProductId] = useState(null);
            const [activeView, setActiveView] = useState('drugs'); // drugs, patents, articles, etc.
            const [user, setUser] = useState(() => {
                const saved = localStorage.getItem('user');
                return saved ? JSON.parse(saved) : null;
            });

            useEffect(() => {
                lucide.createIcons();
            }, [activeView, selectedProductId, user]); // Re-run icons on view change

            const handleLogout = () => {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                setUser(null);
            };

            // Not authenticated - show login
            if (!user) {
                return <LoginPage onLogin={setUser} />;
            }

            // Render Content based on View
            const renderContent = () => {
                switch (activeView) {
                    case 'drugs':
                        return selectedProductId ? (
                            <ProductDetail productId={selectedProductId} onBack={() => setSelectedProductId(null)} />
                        ) : (
                            <Dashboard onSelectProduct={setSelectedProductId} />
                        );
                    case 'patents':
                        return <PatentsView onSelectProduct={setSelectedProductId} />;
                    case 'articles':
                        return <ArticlesView onSelectProduct={setSelectedProductId} />;
                    case 'conferences':
                        return <ConferencesView onSelectProduct={setSelectedProductId} />;
                    case 'adme':
                        return <AdmeView onSelectProduct={setSelectedProductId} />;
                    case 'models':
                        return <ModelsView onSelectProduct={setSelectedProductId} />;
                    case 'preclinical':
                        return <PreclinicalView onSelectProduct={setSelectedProductId} />;
                    case 'synthesis':
                        return <SynthesisView onSelectProduct={setSelectedProductId} />;
                    case 'comparison':
                        return <ComparisonView />;
                    case 'chat':
                        return <ChatView />;
                    case 'clinical':
                        return <ClinicalView onSelectProduct={setSelectedProductId} />;
                    case 'reports':
                        return <ReportsView />;
                    default:
                        return <Dashboard onSelectProduct={setSelectedProductId} />;
                }
            };

            return (
                <div className="flex min-h-screen bg-slate-50">
                    {/* Sidebar */}
                    <Sidebar
                        activeView={activeView}
                        onViewChange={(view) => {
                            setActiveView(view);
                            setSelectedProductId(null); // Reset detail view when switching main sections
                        }}
                        onLogout={handleLogout}
                        user={user}
                    />

                    {/* Main Content Area */}
                    <div className="flex-1 ml-64 transition-all duration-300">
                        {renderContent()}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>